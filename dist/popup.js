import{g as N,d as z,l as i,k as _,y as G,A as J,f as Q,B as X,C as Y,t as Z,n as ee,o as te,v as F,u as H,p as ne,q as se,x as $,D as q}from"./workflow.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const m of r.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&s(m)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const V=document.getElementById("count"),w=document.getElementById("scanBtn"),f=document.getElementById("rescanBtn"),d=document.getElementById("progress"),S=document.getElementById("fileList"),E=document.getElementById("lastScan"),h=document.getElementById("autoRescan"),v=document.getElementById("rescanInterval"),y=document.getElementById("apiKey"),x=document.getElementById("matchMode");N().then(e=>V.textContent=String(e));oe();ie();K();w.addEventListener("click",async()=>{const e=z("scan-popup");i(e,"scan.popup.click");try{i(e,"service.filesystem.showDirectoryPicker.start");const t=await window.showDirectoryPicker({mode:"read"});i(e,"service.filesystem.showDirectoryPicker.done"),await j(t,!1,e)}catch(t){t.name!=="AbortError"?(_(e,"scan.popup.failed",t),d.textContent="Error scanning folder",w.disabled=!1,f&&(f.disabled=!1)):i(e,"scan.popup.cancelled")}});f&&f.addEventListener("click",async()=>{const e=z("rescan-popup");i(e,"rescan.popup.click");try{i(e,"service.vectordb.getDirectoryHandle.start");const t=await G();if(!t){i(e,"rescan.popup.no_directory_handle"),d.textContent="No folder selected yet. Use 'Select folder' first.";return}const n=await t.queryPermission({mode:"read"});if(i(e,"service.filesystem.queryPermission.done",{permission:n}),n!=="granted"){const s=await t.requestPermission({mode:"read"});if(i(e,"service.filesystem.requestPermission.done",{permission:s}),s!=="granted"){d.textContent="Permission denied. Please select folder again.";return}}await j(t,!0,e)}catch(t){_(e,"rescan.popup.failed",t),d.textContent="Error during rescan. Try selecting folder again.",w.disabled=!1,f&&(f.disabled=!1)}});h&&h.addEventListener("change",U);v&&v.addEventListener("change",U);async function j(e,t,n=z(t?"rescan-popup":"scan-popup")){const s=new Set(["filesystem.collectFiles","vectordb.saveDirectoryHandle","embeddings.extractText","embeddings.tokenize","embeddings.buildVocabulary","embeddings.vectorize","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","chrome.runtime.sendMessage:VOCAB_UPDATED","vectordb.getCount"]);i(n,"scan.popup.start",{incremental:t}),w.disabled=!0,f&&(f.disabled=!0),d.textContent="Scanning files...";try{const a=await k(e,"");d.textContent=`Found ${a.length} files. Checking for changes...`,i(n,"service.filesystem.collectFiles.done",{discoveredFiles:a.length}),await J(e),i(n,"service.vectordb.saveDirectoryHandle.done");const r=t?await Q():[],m=new Map(r.map(o=>[o.id,o])),I=new Set;t&&(s.add("vectordb.getAll"),s.add("vectordb.deleteById"));const l=[],b=[];let g=0,B=0;for(let o=0;o<a.length;o++){const{fileHandle:p,path:u}=a[o];I.add(u);try{const c=await p.getFile();if(t){const M=m.get(u);if(M&&M.size===c.size&&M.lastModified===c.lastModified){b.push({path:u,name:c.name,type:c.type||O(c.name),size:c.size,lastModified:c.lastModified,text:M.textPreview}),g++;continue}}const T=await X(c,u);l.push({path:u,name:c.name,type:c.type||O(c.name),size:c.size,lastModified:c.lastModified,text:T})}catch{B++}o%10===0&&(d.textContent=`Reading files... ${o+1}/${a.length}${g>0?` (${g} unchanged)`:""}`)}i(n,"scan.phase.read.done",{discovered:a.length,toProcess:l.length,unchanged:g,unreadable:B});let C=0;if(t){for(const o of m.keys())I.has(o)||(await Y(o),C++);i(n,"scan.phase.deleted.done",{deleted:C})}if(t&&l.length===0&&C===0){d.textContent=`No changes detected. ${g} files up to date.`,await R(),i(n,"scan.popup.no_changes",{unchanged:g}),i(n,"scan.popup.services_called",Array.from(s));return}d.textContent=`Building vectors... (${l.length} new/modified, ${g} unchanged, ${C} deleted)`;const L=[...l,...b],P=L.map(o=>Z(o.text));ee(P),i(n,"scan.phase.vocab.done",{vocabDocs:L.length}),t||(await te(),s.add("vectordb.clearAll"),i(n,"service.vectordb.clearAll.done"));for(let o=0;o<l.length;o++){const p=l[o],u=F(P[o]),c={id:p.path,name:p.name,path:p.path,type:p.type,size:p.size,lastModified:p.lastModified,vector:u,textPreview:p.text.slice(0,500)};await H(c),o%10===0&&(d.textContent=`Indexing... ${o+1}/${l.length}`)}if(t&&b.length>0){d.textContent="Updating vectors for unchanged files...";for(let o=0;o<b.length;o++){const p=b[o],u=l.length+o,c=F(P[u]),T=m.get(p.path);await H({...T,vector:c})}}i(n,"scan.phase.index.done",{updated:l.length,revectorized:b.length});const A=ne();await se(A),chrome.storage.local.set({vocab:A},()=>{chrome.runtime.sendMessage({type:"VOCAB_UPDATED"},()=>{chrome.runtime.lastError})}),i(n,"scan.phase.persist.done",{vocabTerms:A.terms.length}),await R();const D=await N();V.textContent=String(D),d.textContent=t?`Done! ${l.length} updated, ${C} removed, ${D} total.`:`Done! ${D} files indexed.`,ae(L),i(n,"scan.popup.services_called",Array.from(s)),i(n,"scan.popup.done",{totalIndexed:D,updated:l.length,unchanged:g,deleted:C,unreadable:B})}catch(a){_(n,"scan.popup.failed",a),d.textContent=t?"Error during rescan. Try selecting folder again.":"Error scanning folder"}finally{w.disabled=!1,f&&(f.disabled=!1)}}async function k(e,t){const n=[];for await(const s of e.values()){const a=t?`${t}/${s.name}`:s.name;if(s.kind==="file")n.push({fileHandle:s,path:a});else if(s.kind==="directory"&&!s.name.startsWith(".")){const r=await k(s,a);n.push(...r)}}return n}function O(e){var s;const t=((s=e.split(".").pop())==null?void 0:s.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[t]||"application/octet-stream"}function ae(e){S.innerHTML="";const t=[...e].sort((n,s)=>s.lastModified-n.lastModified);for(const n of t.slice(0,50)){const s=document.createElement("div");s.textContent=n.path,S.appendChild(s)}if(e.length>50){const n=document.createElement("div");n.textContent=`... and ${e.length-50} more`,S.appendChild(n)}}async function oe(){const e=await $();h&&(h.checked=e.autoRescanEnabled),v&&(v.value=String(e.rescanIntervalMin))}async function U(){const e=await $();e.autoRescanEnabled=(h==null?void 0:h.checked)??!0,e.rescanIntervalMin=parseInt((v==null?void 0:v.value)??"30",10),await q(e),chrome.runtime.sendMessage({type:"RESCAN_CONFIG_UPDATED"},()=>{chrome.runtime.lastError})}async function R(){const e=await $();e.lastScanTimestamp=Date.now(),await q(e),K()}async function K(){if(!E)return;const e=await $();if(e.lastScanTimestamp===0){E.textContent="Never scanned";return}const t=Date.now()-e.lastScanTimestamp,n=Math.floor(t/6e4);n<1?E.textContent="Last scan: just now":n<60?E.textContent=`Last scan: ${n}m ago`:E.textContent=`Last scan: ${Math.floor(n/60)}h ${n%60}m ago`}function ie(){chrome.storage.local.get("xupload_config",e=>{const t=e.xupload_config||{apiKey:"",mode:"tfidf"};y&&(y.value=t.apiKey||""),x&&(x.value=t.mode||"tfidf")})}function W(){const e={apiKey:(y==null?void 0:y.value)||"",mode:(x==null?void 0:x.value)||"tfidf"};chrome.storage.local.set({xupload_config:e})}y&&y.addEventListener("change",W);x&&x.addEventListener("change",W);
