import{g as k,d as T,l as i,j as $,y as Q,A as X,f as Y,B as Z,C as ee,t as te,m as ne,n as ae,v as O,u as U,o as oe,p as se,x as P,D as q}from"./workflow.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const m of d.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function n(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function a(o){if(o.ep)return;o.ep=!0;const d=n(o);fetch(o.href,d)}})();const H=document.getElementById("count"),b=document.getElementById("scanBtn"),l=document.getElementById("rescanBtn"),M=document.getElementById("clearBtn"),r=document.getElementById("progress"),A=document.getElementById("fileList"),w=document.getElementById("lastScan"),h=document.getElementById("autoRescan"),y=document.getElementById("rescanInterval"),v=document.getElementById("apiKey"),x=document.getElementById("matchMode"),B=document.getElementById("enableToggle");k().then(e=>H.textContent=String(e));ce();re();N();de();b.addEventListener("click",async()=>{const e=T("scan-popup");i(e,"scan.popup.click");try{i(e,"service.filesystem.showDirectoryPicker.start");const t=await window.showDirectoryPicker({mode:"read"});i(e,"service.filesystem.showDirectoryPicker.done"),await K(t,!1,e)}catch(t){t.name!=="AbortError"?($(e,"scan.popup.failed",t),r.textContent="Error scanning folder",b.disabled=!1,l&&(l.disabled=!1)):i(e,"scan.popup.cancelled")}});l&&l.addEventListener("click",async()=>{const e=T("rescan-popup");i(e,"rescan.popup.click");try{i(e,"service.vectordb.getDirectoryHandle.start");const t=await Q();if(!t){i(e,"rescan.popup.no_directory_handle"),r.textContent="No folder selected yet. Use 'Select folder' first.";return}const n=await t.queryPermission({mode:"read"});if(i(e,"service.filesystem.queryPermission.done",{permission:n}),n!=="granted"){const a=await t.requestPermission({mode:"read"});if(i(e,"service.filesystem.requestPermission.done",{permission:a}),a!=="granted"){r.textContent="Permission denied. Please select folder again.";return}}await K(t,!0,e)}catch(t){$(e,"rescan.popup.failed",t),r.textContent="Error during rescan. Try selecting folder again.",b.disabled=!1,l&&(l.disabled=!1)}});M&&M.addEventListener("click",async()=>{if(!window.confirm("Clear all scanned xUpload data? This only clears xUpload index, not your actual files."))return;const t=T("clear-popup");i(t,"clear.popup.click"),b.disabled=!0,l&&(l.disabled=!0),M.disabled=!0,r.textContent="Clearing scanned data...";try{const n=await chrome.runtime.sendMessage({type:"CLEAR_SCANNED_DATA",workflowId:t});if(!(n!=null&&n.ok))throw new Error((n==null?void 0:n.error)||"Failed to clear scanned data.");const a=await k();H.textContent=String(a),A.innerHTML="",await N(),r.textContent="Scanned data cleared.",i(t,"clear.popup.done",{remainingIndexedCount:a})}catch(n){$(t,"clear.popup.failed",n),r.textContent="Failed to clear scanned data."}finally{b.disabled=!1,l&&(l.disabled=!1),M.disabled=!1}});h&&h.addEventListener("change",G);y&&y.addEventListener("change",G);async function K(e,t,n=T(t?"rescan-popup":"scan-popup")){const a=new Set(["filesystem.collectFiles","vectordb.saveDirectoryHandle","embeddings.extractText","embeddings.tokenize","embeddings.buildVocabulary","embeddings.vectorize","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","chrome.runtime.sendMessage:VOCAB_UPDATED","vectordb.getCount"]);i(n,"scan.popup.start",{incremental:t}),b.disabled=!0,l&&(l.disabled=!0),r.textContent="Scanning files...";try{const o=await W(e,"");r.textContent=`Found ${o.length} files. Checking for changes...`,i(n,"service.filesystem.collectFiles.done",{discoveredFiles:o.length}),await X(e),i(n,"service.vectordb.saveDirectoryHandle.done");const d=t?await Y():[],m=new Map(d.map(s=>[s.id,s])),R=new Set;t&&(a.add("vectordb.getAll"),a.add("vectordb.deleteById"));const f=[],C=[];let g=0,S=0;for(let s=0;s<o.length;s++){const{fileHandle:p,path:u}=o[s];R.add(u);try{const c=await p.getFile();if(t){const L=m.get(u);if(L&&L.size===c.size&&L.lastModified===c.lastModified){C.push({path:u,name:c.name,type:c.type||V(c.name),size:c.size,lastModified:c.lastModified,text:L.textPreview}),g++;continue}}const F=await Z(c,u);f.push({path:u,name:c.name,type:c.type||V(c.name),size:c.size,lastModified:c.lastModified,text:F})}catch{S++}s%10===0&&(r.textContent=`Reading files... ${s+1}/${o.length}${g>0?` (${g} unchanged)`:""}`)}i(n,"scan.phase.read.done",{discovered:o.length,toProcess:f.length,unchanged:g,unreadable:S});let E=0;if(t){for(const s of m.keys())R.has(s)||(await ee(s),E++);i(n,"scan.phase.deleted.done",{deleted:E})}if(t&&f.length===0&&E===0){r.textContent=`No changes detected. ${g} files up to date.`,await j(),i(n,"scan.popup.no_changes",{unchanged:g}),i(n,"scan.popup.services_called",Array.from(a));return}r.textContent=`Building vectors... (${f.length} new/modified, ${g} unchanged, ${E} deleted)`;const _=[...f,...C],I=_.map(s=>te(s.text));ne(I),i(n,"scan.phase.vocab.done",{vocabDocs:_.length}),t||(await ae(),a.add("vectordb.clearAll"),i(n,"service.vectordb.clearAll.done"));for(let s=0;s<f.length;s++){const p=f[s],u=O(I[s]),c={id:p.path,name:p.name,path:p.path,type:p.type,size:p.size,lastModified:p.lastModified,vector:u,textPreview:p.text.slice(0,500)};await U(c),s%10===0&&(r.textContent=`Indexing... ${s+1}/${f.length}`)}if(t&&C.length>0){r.textContent="Updating vectors for unchanged files...";for(let s=0;s<C.length;s++){const p=C[s],u=f.length+s,c=O(I[u]),F=m.get(p.path);await U({...F,vector:c})}}i(n,"scan.phase.index.done",{updated:f.length,revectorized:C.length});const z=oe();await se(z),chrome.storage.local.set({vocab:z},()=>{chrome.runtime.sendMessage({type:"VOCAB_UPDATED"},()=>{chrome.runtime.lastError})}),i(n,"scan.phase.persist.done",{vocabTerms:z.terms.length}),await j();const D=await k();H.textContent=String(D),r.textContent=t?`Done! ${f.length} updated, ${E} removed, ${D} total.`:`Done! ${D} files indexed.`,ie(_),i(n,"scan.popup.services_called",Array.from(a)),i(n,"scan.popup.done",{totalIndexed:D,updated:f.length,unchanged:g,deleted:E,unreadable:S})}catch(o){$(n,"scan.popup.failed",o),r.textContent=t?"Error during rescan. Try selecting folder again.":"Error scanning folder"}finally{b.disabled=!1,l&&(l.disabled=!1)}}async function W(e,t){const n=[];for await(const a of e.values()){const o=t?`${t}/${a.name}`:a.name;if(a.kind==="file")n.push({fileHandle:a,path:o});else if(a.kind==="directory"&&!a.name.startsWith(".")){const d=await W(a,o);n.push(...d)}}return n}function V(e){var a;const t=((a=e.split(".").pop())==null?void 0:a.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[t]||"application/octet-stream"}function ie(e){A.innerHTML="";const t=[...e].sort((n,a)=>a.lastModified-n.lastModified);for(const n of t.slice(0,50)){const a=document.createElement("div");a.textContent=n.path,A.appendChild(a)}if(e.length>50){const n=document.createElement("div");n.textContent=`... and ${e.length-50} more`,A.appendChild(n)}}async function ce(){const e=await P();h&&(h.checked=e.autoRescanEnabled),y&&(y.value=String(e.rescanIntervalMin))}async function G(){const e=await P();e.autoRescanEnabled=(h==null?void 0:h.checked)??!0,e.rescanIntervalMin=parseInt((y==null?void 0:y.value)??"30",10),await q(e),chrome.runtime.sendMessage({type:"RESCAN_CONFIG_UPDATED"},()=>{chrome.runtime.lastError})}async function j(){const e=await P();e.lastScanTimestamp=Date.now(),await q(e),N()}async function N(){if(!w)return;const e=await P();if(e.lastScanTimestamp===0){w.textContent="Never scanned";return}const t=Date.now()-e.lastScanTimestamp,n=Math.floor(t/6e4);n<1?w.textContent="Last scan: just now":n<60?w.textContent=`Last scan: ${n}m ago`:w.textContent=`Last scan: ${Math.floor(n/60)}h ${n%60}m ago`}function re(){chrome.storage.local.get("xupload_config",e=>{const t=e.xupload_config||{apiKey:"",mode:"tfidf"};v&&(v.value=t.apiKey||""),x&&(x.value=t.mode||"tfidf")})}function J(){const e={apiKey:(v==null?void 0:v.value)||"",mode:(x==null?void 0:x.value)||"tfidf"};chrome.storage.local.set({xupload_config:e})}v&&v.addEventListener("change",J);x&&x.addEventListener("change",J);function de(){chrome.storage.local.get("xupload_enabled",e=>{const t=e.xupload_enabled!==!1;B&&(B.checked=t)})}B&&B.addEventListener("change",()=>{const e=B.checked;chrome.storage.local.set({xupload_enabled:e})});
