const j=new Set(["a","an","the","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","shall","should","may","might","must","can","could","i","me","my","we","our","you","your","he","him","his","she","her","it","its","they","them","their","this","that","these","those","am","if","or","and","but","not","no","nor","so","as","at","by","for","in","of","on","to","up","from","with","into","out","about","all","any","each","some","such","than","too","very","just","also","how","what","when","where","which","who","here","there","then","only","after","before"]);function M(r){const t=r.toLowerCase().trim(),o=[],n=t.match(/[a-z0-9]+/g)||[];o.push(...n);const e=t.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g)||[];o.push(...e);for(let s=0;s<e.length-1;s++)o.push(e[s]+e[s+1]);return o}function D(r){return M(r).filter(t=>!j.has(t)&&t.length>1)}let p=new Map,h=new Map;function A(r){const t=new Map,o=r.length;for(const e of r){const s=new Set(e);for(const a of s)t.set(a,(t.get(a)||0)+1)}p=new Map,h=new Map;let n=0;for(const[e,s]of t)p.set(e,n++),h.set(e,Math.log((o+1)/(s+1))+1)}function H(){return p.size}function U(r){const t=p.size;if(t===0)return[];const o=new Array(t).fill(0),n=new Map;for(const a of r)n.set(a,(n.get(a)||0)+1);const e=Math.max(...n.values(),1);for(const[a,c]of n){const i=p.get(a);i!==void 0&&(o[i]=c/e*(h.get(a)||1))}let s=0;for(const a of o)s+=a*a;if(s=Math.sqrt(s),s>0)for(let a=0;a<o.length;a++)o[a]/=s;return o}async function T(r,t){var s;const o=r.name.replace(/[._-]/g," "),n=((s=r.name.split(".").pop())==null?void 0:s.toLowerCase())||"",e=t?t.replace(/[/\\._-]/g," "):o;if(v(n))try{const a=await r.text();return`${e} ${a.slice(0,2e3)}`}catch{return e}if(n==="pdf")try{const a=await P(r);return a.length>10?`${e} ${a.slice(0,2e3)}`:`${e} pdf document`}catch{return`${e} pdf document`}return["jpg","jpeg","png","gif","webp","bmp","svg","tiff","heic"].includes(n)?`${e} image photo picture`:["doc","docx"].includes(n)?`${e} document word`:["xls","xlsx"].includes(n)?`${e} spreadsheet excel`:["ppt","pptx"].includes(n)?`${e} presentation slides`:e}function v(r){return["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"].includes(r)}async function P(r){const t=await r.arrayBuffer(),o=new Uint8Array(t);let n="";const e=Math.min(o.length,5e5);for(let i=0;i<e;i++)n+=String.fromCharCode(o[i]);const s=[],a=/BT\s([\s\S]*?)ET/g;let c;for(;(c=a.exec(n))!==null;){const i=/\(([^)]*)\)/g;let u;for(;(u=i.exec(c[1]))!==null;)s.push(u[1])}return s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim()}function B(){const r=new Array(p.size),t=new Array(p.size);for(const[o,n]of p)r[n]=o,t[n]=h.get(o)||1;return{terms:r,idf:t}}function E(r){p=new Map,h=new Map;for(let t=0;t<r.terms.length;t++)p.set(r.terms[t],t),h.set(r.terms[t],r.idf[t])}const $="xupload_vectors",C=5,f="files",y="dir_handles",g="vocabulary",b="upload_history",m="config";function d(){return new Promise((r,t)=>{const o=indexedDB.open($,C);o.onupgradeneeded=()=>{const n=o.result;if(n.objectStoreNames.contains(f)&&n.deleteObjectStore(f),n.createObjectStore(f,{keyPath:"id"}),n.objectStoreNames.contains(y)||n.createObjectStore(y),n.objectStoreNames.contains(g)||n.createObjectStore(g),!n.objectStoreNames.contains(b)){const e=n.createObjectStore(b,{keyPath:"id",autoIncrement:!0});e.createIndex("websiteHost","websiteHost",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}n.objectStoreNames.contains(m)||n.createObjectStore(m)},o.onsuccess=()=>r(o.result),o.onerror=()=>t(o.error)})}async function _(r){const t=await d();return new Promise((o,n)=>{const e=t.transaction(f,"readwrite");e.objectStore(f).put(r),e.oncomplete=()=>o(),e.onerror=()=>n(e.error)})}async function x(){const r=await d();return new Promise((t,o)=>{const e=r.transaction(f,"readonly").objectStore(f).getAll();e.onsuccess=()=>t(e.result),e.onerror=()=>o(e.error)})}async function O(r){const t=await d();return new Promise((o,n)=>{const s=t.transaction(f,"readonly").objectStore(f).get(r);s.onsuccess=()=>o(s.result??void 0),s.onerror=()=>n(s.error)})}async function z(){const r=await d();return new Promise((t,o)=>{const e=r.transaction(f,"readonly").objectStore(f).count();e.onsuccess=()=>t(e.result),e.onerror=()=>o(e.error)})}async function N(){const r=await d();return new Promise((t,o)=>{const n=r.transaction(f,"readwrite");n.objectStore(f).clear(),n.oncomplete=()=>t(),n.onerror=()=>o(n.error)})}function S(r,t){let o=0,n=0,e=0;for(let s=0;s<r.length;s++)o+=r[s]*t[s],n+=r[s]*r[s],e+=t[s]*t[s];return n===0||e===0?0:o/(Math.sqrt(n)*Math.sqrt(e))}async function V(r,t=5,o){const n=await x();let e=n;if(o){const s=o.split(",").map(c=>c.trim().toLowerCase()),a=n.filter(c=>{var w;const i="."+((w=c.name.split(".").pop())==null?void 0:w.toLowerCase()),u=c.type.toLowerCase();return s.some(l=>l===i||l===u||l.endsWith("/*")&&u.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:S(r,s.vector)})).sort((s,a)=>a.score-s.score).slice(0,t).filter(s=>s.score>0)}async function R(r){const t=await d();return new Promise((o,n)=>{const e=t.transaction(y,"readwrite");e.objectStore(y).put(r,"main"),e.oncomplete=()=>o(),e.onerror=()=>n(e.error)})}async function q(){const r=await d();return new Promise((t,o)=>{const e=r.transaction(y,"readonly").objectStore(y).get("main");e.onsuccess=()=>t(e.result??null),e.onerror=()=>o(e.error)})}async function W(r){const t=await O(r);if(!t)return console.error("[xUpload] getFileData: record not found for id:",r),null;const o=await q();if(!o)return console.error("[xUpload] getFileData: no directory handle stored"),null;try{const n=await o.queryPermission({mode:"read"});if(console.log("[xUpload] Directory handle permission:",n),n!=="granted")return console.warn("[xUpload] Directory permission not granted. User must re-authorize from popup."),null;const e=t.path.split("/");console.log("[xUpload] Navigating path parts:",e);let s=o;for(let l=0;l<e.length-1;l++)s=await s.getDirectoryHandle(e[l]);const i=await(await(await s.getFileHandle(e[e.length-1])).getFile()).arrayBuffer(),u=new Uint8Array(i);let w="";for(let l=0;l<u.length;l++)w+=String.fromCharCode(u[l]);return{name:t.name,type:t.type,lastModified:t.lastModified,base64:btoa(w)}}catch(n){return console.error("[xUpload] Failed to read file on-demand:",n),null}}async function F(r){const t=await d();return new Promise((o,n)=>{const e=t.transaction(g,"readwrite");e.objectStore(g).put(r,"main"),e.oncomplete=()=>o(),e.onerror=()=>n(e.error)})}async function k(){const r=await d();return new Promise((t,o)=>{const e=r.transaction(g,"readonly").objectStore(g).get("main");e.onsuccess=()=>t(e.result??null),e.onerror=()=>o(e.error)})}async function I(r){const t=await d();return new Promise((o,n)=>{const e=t.transaction(b,"readwrite");e.objectStore(b).add(r),e.oncomplete=()=>o(),e.onerror=()=>n(e.error)})}async function L(r,t=50){const o=await d();return new Promise((n,e)=>{const c=o.transaction(b,"readonly").objectStore(b).index("websiteHost").getAll(r,t);c.onsuccess=()=>n(c.result),c.onerror=()=>e(c.error)})}async function G(r){const t=await d();return new Promise((o,n)=>{const e=t.transaction(f,"readwrite");e.objectStore(f).delete(r),e.oncomplete=()=>o(),e.onerror=()=>n(e.error)})}async function K(){const r=await d();return new Promise((t,o)=>{const e=r.transaction(m,"readonly").objectStore(m).get("rescan");e.onsuccess=()=>t(e.result??{autoRescanEnabled:!0,rescanIntervalMin:30,lastScanTimestamp:0}),e.onerror=()=>o(e.error)})}async function Y(r){const t=await d();return new Promise((o,n)=>{const e=t.transaction(m,"readwrite");e.objectStore(m).put(r,"rescan"),e.oncomplete=()=>o(),e.onerror=()=>n(e.error)})}async function J(r,t=5,o){let e=(await x()).filter(s=>s.denseVector&&s.denseVector.length>0);if(e.length===0)return[];if(o){const s=o.split(",").map(c=>c.trim().toLowerCase()),a=e.filter(c=>{var w;const i="."+((w=c.name.split(".").pop())==null?void 0:w.toLowerCase()),u=c.type.toLowerCase();return s.some(l=>l===i||l===u||l.endsWith("/*")&&u.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:S(r,s.denseVector)})).sort((s,a)=>a.score-s.score).slice(0,t).filter(s=>s.score>0)}async function Q(r,t){const o=await d(),n=await new Promise((a,c)=>{const u=o.transaction(m,"readonly").objectStore(m).get("pathMemory");u.onsuccess=()=>a(u.result??{}),u.onerror=()=>c(u.error)}),e=n[r]||[],s=e.indexOf(t);return s!==-1&&e.splice(s,1),e.unshift(t),e.length>20&&(e.length=20),n[r]=e,new Promise((a,c)=>{const i=o.transaction(m,"readwrite");i.objectStore(m).put(n,"pathMemory"),i.oncomplete=()=>a(),i.onerror=()=>c(i.error)})}async function X(r){const t=await d();return new Promise((o,n)=>{const s=t.transaction(m,"readonly").objectStore(m).get("pathMemory");s.onsuccess=()=>{const a=s.result??{};o(a[r]||[])},s.onerror=()=>n(s.error)})}function Z(r){const t=Date.now().toString(36),o=Math.random().toString(36).slice(2,8);return`${r}-${t}-${o}`}function ee(r,t=4){const o=Math.pow(10,t);return Math.round(r*o)/o}function te(r,t,o){if(o===void 0){console.log(`[xUpload][WF:${r}] ${t}`);return}console.log(`[xUpload][WF:${r}] ${t}`,o)}function oe(r,t,o){console.error(`[xUpload][WF:${r}] ${t}`,o)}export{R as A,T as B,G as C,Y as D,k as a,H as b,I as c,Z as d,V as e,x as f,z as g,L as h,E as i,X as j,oe as k,te as l,J as m,A as n,N as o,B as p,F as q,ee as r,Q as s,M as t,_ as u,U as v,W as w,K as x,q as y,D as z};
