const j=new Set(["a","an","the","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","shall","should","may","might","must","can","could","i","me","my","we","our","you","your","he","him","his","she","her","it","its","they","them","their","this","that","these","those","am","if","or","and","but","not","no","nor","so","as","at","by","for","in","of","on","to","up","from","with","into","out","about","all","any","each","some","such","than","too","very","just","also","how","what","when","where","which","who","here","there","then","only","after","before"]);function M(n){const o=n.toLowerCase().trim(),r=[],t=o.match(/[a-z0-9]+/g)||[];r.push(...t);const e=o.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g)||[];r.push(...e);for(let s=0;s<e.length-1;s++)r.push(e[s]+e[s+1]);return r}function q(n){return M(n).filter(o=>!j.has(o)&&o.length>1)}let p=new Map,b=new Map;function T(n){const o=new Map,r=n.length;for(const e of n){const s=new Set(e);for(const a of s)o.set(a,(o.get(a)||0)+1)}p=new Map,b=new Map;let t=0;for(const[e,s]of o)p.set(e,t++),b.set(e,Math.log((r+1)/(s+1))+1)}function A(){return p.size}function H(n){const o=p.size;if(o===0)return[];const r=new Array(o).fill(0),t=new Map;for(const a of n)t.set(a,(t.get(a)||0)+1);const e=Math.max(...t.values(),1);for(const[a,c]of t){const i=p.get(a);i!==void 0&&(r[i]=c/e*(b.get(a)||1))}let s=0;for(const a of r)s+=a*a;if(s=Math.sqrt(s),s>0)for(let a=0;a<r.length;a++)r[a]/=s;return r}async function E(n,o){var s;const r=n.name.replace(/[._-]/g," "),t=((s=n.name.split(".").pop())==null?void 0:s.toLowerCase())||"",e=o?o.replace(/[/\\._-]/g," "):r;if(v(t))try{const a=await n.text();return`${e} ${a.slice(0,2e3)}`}catch{return e}if(t==="pdf")try{const a=await P(n);return a.length>10?`${e} ${a.slice(0,2e3)}`:`${e} pdf document`}catch{return`${e} pdf document`}return["jpg","jpeg","png","gif","webp","bmp","svg","tiff","heic"].includes(t)?`${e} image photo picture`:["doc","docx"].includes(t)?`${e} document word`:["xls","xlsx"].includes(t)?`${e} spreadsheet excel`:["ppt","pptx"].includes(t)?`${e} presentation slides`:e}function v(n){return["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"].includes(n)}async function P(n){const o=await n.arrayBuffer(),r=new Uint8Array(o);let t="";const e=Math.min(r.length,5e5);for(let i=0;i<e;i++)t+=String.fromCharCode(r[i]);const s=[],a=/BT\s([\s\S]*?)ET/g;let c;for(;(c=a.exec(t))!==null;){const i=/\(([^)]*)\)/g;let d;for(;(d=i.exec(c[1]))!==null;)s.push(d[1])}return s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim()}function U(){const n=new Array(p.size),o=new Array(p.size);for(const[r,t]of p)n[t]=r,o[t]=b.get(r)||1;return{terms:n,idf:o}}function B(n){p=new Map,b=new Map;for(let o=0;o<n.terms.length;o++)p.set(n.terms[o],o),b.set(n.terms[o],n.idf[o])}const $="xupload_vectors",C=5,u="files",h="dir_handles",g="vocabulary",y="upload_history",m="config";function f(){return new Promise((n,o)=>{const r=indexedDB.open($,C);r.onupgradeneeded=()=>{const t=r.result;if(t.objectStoreNames.contains(u)&&t.deleteObjectStore(u),t.createObjectStore(u,{keyPath:"id"}),t.objectStoreNames.contains(h)||t.createObjectStore(h),t.objectStoreNames.contains(g)||t.createObjectStore(g),!t.objectStoreNames.contains(y)){const e=t.createObjectStore(y,{keyPath:"id",autoIncrement:!0});e.createIndex("websiteHost","websiteHost",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains(m)||t.createObjectStore(m)},r.onsuccess=()=>n(r.result),r.onerror=()=>o(r.error)})}async function _(n){const o=await f();return new Promise((r,t)=>{const e=o.transaction(u,"readwrite");e.objectStore(u).put(n),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function x(){const n=await f();return new Promise((o,r)=>{const e=n.transaction(u,"readonly").objectStore(u).getAll();e.onsuccess=()=>o(e.result),e.onerror=()=>r(e.error)})}async function D(n){const o=await f();return new Promise((r,t)=>{const s=o.transaction(u,"readonly").objectStore(u).get(n);s.onsuccess=()=>r(s.result??void 0),s.onerror=()=>t(s.error)})}async function z(){const n=await f();return new Promise((o,r)=>{const e=n.transaction(u,"readonly").objectStore(u).count();e.onsuccess=()=>o(e.result),e.onerror=()=>r(e.error)})}async function N(){const n=await f();return new Promise((o,r)=>{const t=n.transaction(u,"readwrite");t.objectStore(u).clear(),t.oncomplete=()=>o(),t.onerror=()=>r(t.error)})}function S(n,o){let r=0,t=0,e=0;for(let s=0;s<n.length;s++)r+=n[s]*o[s],t+=n[s]*n[s],e+=o[s]*o[s];return t===0||e===0?0:r/(Math.sqrt(t)*Math.sqrt(e))}async function R(n,o=5,r){const t=await x();let e=t;if(r){const s=r.split(",").map(c=>c.trim().toLowerCase()),a=t.filter(c=>{var w;const i="."+((w=c.name.split(".").pop())==null?void 0:w.toLowerCase()),d=c.type.toLowerCase();return s.some(l=>l===i||l===d||l.endsWith("/*")&&d.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:S(n,s.vector)})).sort((s,a)=>a.score-s.score).slice(0,o).filter(s=>s.score>0)}async function V(n){const o=await f();return new Promise((r,t)=>{const e=o.transaction(h,"readwrite");e.objectStore(h).put(n,"main"),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function O(){const n=await f();return new Promise((o,r)=>{const e=n.transaction(h,"readonly").objectStore(h).get("main");e.onsuccess=()=>o(e.result??null),e.onerror=()=>r(e.error)})}async function W(n){const o=await D(n);if(!o)return console.error("[xUpload] getFileData: record not found for id:",n),null;const r=await O();if(!r)return console.error("[xUpload] getFileData: no directory handle stored"),null;try{const t=await r.queryPermission({mode:"read"});if(console.log("[xUpload] Directory handle permission:",t),t!=="granted")return console.warn("[xUpload] Directory permission not granted. User must re-authorize from popup."),null;const e=o.path.split("/");console.log("[xUpload] Navigating path parts:",e);let s=r;for(let l=0;l<e.length-1;l++)s=await s.getDirectoryHandle(e[l]);const i=await(await(await s.getFileHandle(e[e.length-1])).getFile()).arrayBuffer(),d=new Uint8Array(i);let w="";for(let l=0;l<d.length;l++)w+=String.fromCharCode(d[l]);return{name:o.name,type:o.type,lastModified:o.lastModified,base64:btoa(w)}}catch(t){return console.error("[xUpload] Failed to read file on-demand:",t),null}}async function F(n){const o=await f();return new Promise((r,t)=>{const e=o.transaction(g,"readwrite");e.objectStore(g).put(n,"main"),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function I(){const n=await f();return new Promise((o,r)=>{const e=n.transaction(g,"readonly").objectStore(g).get("main");e.onsuccess=()=>o(e.result??null),e.onerror=()=>r(e.error)})}async function k(n){const o=await f();return new Promise((r,t)=>{const e=o.transaction(y,"readwrite");e.objectStore(y).add(n),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function L(n,o=50){const r=await f();return new Promise((t,e)=>{const c=r.transaction(y,"readonly").objectStore(y).index("websiteHost").getAll(n,o);c.onsuccess=()=>t(c.result),c.onerror=()=>e(c.error)})}async function G(n){const o=await f();return new Promise((r,t)=>{const e=o.transaction(u,"readwrite");e.objectStore(u).delete(n),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function K(){const n=await f();return new Promise((o,r)=>{const e=n.transaction(m,"readonly").objectStore(m).get("rescan");e.onsuccess=()=>o(e.result??{autoRescanEnabled:!0,rescanIntervalMin:30,lastScanTimestamp:0}),e.onerror=()=>r(e.error)})}async function Y(n){const o=await f();return new Promise((r,t)=>{const e=o.transaction(m,"readwrite");e.objectStore(m).put(n,"rescan"),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function J(){const n=await f();return new Promise((o,r)=>{const t=n.transaction([u,g,y,h,m],"readwrite");t.objectStore(u).clear(),t.objectStore(g).delete("main"),t.objectStore(y).clear(),t.objectStore(h).delete("main"),t.objectStore(m).delete("pathMemory");const e=t.objectStore(m),s=e.get("rescan");s.onsuccess=()=>{const a=s.result??{autoRescanEnabled:!0,rescanIntervalMin:30,lastScanTimestamp:0};a.lastScanTimestamp=0,e.put(a,"rescan")},t.oncomplete=()=>o(),t.onerror=()=>r(t.error),t.onabort=()=>r(t.error)})}async function Q(n,o=5,r){let e=(await x()).filter(s=>s.denseVector&&s.denseVector.length>0);if(e.length===0)return[];if(r){const s=r.split(",").map(c=>c.trim().toLowerCase()),a=e.filter(c=>{var w;const i="."+((w=c.name.split(".").pop())==null?void 0:w.toLowerCase()),d=c.type.toLowerCase();return s.some(l=>l===i||l===d||l.endsWith("/*")&&d.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:S(n,s.denseVector)})).sort((s,a)=>a.score-s.score).slice(0,o).filter(s=>s.score>0)}async function X(n,o){const r=await f(),t=await new Promise((a,c)=>{const d=r.transaction(m,"readonly").objectStore(m).get("pathMemory");d.onsuccess=()=>a(d.result??{}),d.onerror=()=>c(d.error)}),e=t[n]||[],s=e.indexOf(o);return s!==-1&&e.splice(s,1),e.unshift(o),e.length>20&&(e.length=20),t[n]=e,new Promise((a,c)=>{const i=r.transaction(m,"readwrite");i.objectStore(m).put(t,"pathMemory"),i.oncomplete=()=>a(),i.onerror=()=>c(i.error)})}function Z(n){const o=Date.now().toString(36),r=Math.random().toString(36).slice(2,8);return`${n}-${o}-${r}`}function ee(n,o=4){const r=Math.pow(10,o);return Math.round(n*r)/r}function te(n,o,r){if(r===void 0){console.log(`[xUpload][WF:${n}] ${o}`);return}console.log(`[xUpload][WF:${n}] ${o}`,r)}function oe(n,o,r){console.error(`[xUpload][WF:${n}] ${o}`,r)}export{V as A,E as B,G as C,Y as D,I as a,A as b,k as c,Z as d,R as e,x as f,z as g,L as h,B as i,oe as j,Q as k,te as l,T as m,N as n,U as o,F as p,W as q,ee as r,X as s,M as t,_ as u,H as v,J as w,K as x,O as y,q as z};
