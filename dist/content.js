(function(){"use strict";function w(t){const e=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${t}-${e}-${n}`}function d(t,e,n){if(n===void 0){console.log(`[xUpload][WF:${t}] ${e}`);return}console.log(`[xUpload][WF:${t}] ${e}`,n)}function T(t,e,n){console.error(`[xUpload][WF:${t}] ${e}`,n)}const N="xupload-btn",C="xupload-panel",_=new WeakSet,j=/upload|browse|choose file|select file|‰∏ä‰º†|ÈÄâÊã©Êñá‰ª∂|ÈôÑ‰ª∂|attach/i;let b=null;function B(){const t=[];document.querySelectorAll('input[type="file"]').forEach(a=>{_.has(a)||k(a)&&t.push({anchor:a,fileInput:a,context:W(a),accept:a.accept||void 0})});const e=new Set(t.map(a=>a.anchor)),n=new Set(t.filter(a=>a.fileInput).map(a=>a.fileInput));return document.querySelectorAll('button, a, [role="button"], label[for], .upload-btn, [class*="upload"], [class*="Upload"]').forEach(a=>{if(_.has(a)||e.has(a))return;const i=a.textContent||"";if(!j.test(i)||a.querySelector(`.${N}`)||a.closest(`.${C}`))return;const c=$(a);if(!(c&&n.has(c))){if(!c){const m=a.closest("form, fieldset, div, section, tr, li")||a.parentElement;if(m){const p=m.querySelector('input[type="file"]');if(p&&(n.has(p)||e.has(p)))return}}t.push({anchor:a,fileInput:c,context:O(a),accept:(c==null?void 0:c.accept)||void 0})}}),t}function k(t){const e=getComputedStyle(t);return e.display!=="none"&&e.visibility!=="hidden"&&t.offsetWidth>0&&t.offsetHeight>0}function $(t){const e=t.querySelector('input[type="file"]');if(e)return e;const n=t.parentElement;if(n){const a=n.querySelector('input[type="file"]');if(a)return a}let o=t;for(let a=0;a<3&&o;a++)if(o=o.parentElement,o){const i=o.querySelector('input[type="file"]');if(i)return i}return null}function W(t){const e=[];if(t.id){const i=document.querySelector(`label[for="${t.id}"]`);i&&e.push(i.textContent||"")}const n=t.closest("label");n&&e.push(n.textContent||""),t.placeholder&&e.push(t.placeholder),t.title&&e.push(t.title);const o=t.getAttribute("aria-label");o&&e.push(o);const a=t.closest("[class*='upload'], [class*='Upload'], div, fieldset, section, td, li")||t.parentElement;return a&&e.push((a.textContent||"").slice(0,300)),e.join(" ").trim()}function O(t){const e=[];e.push(t.textContent||"");const n=t.getAttribute("aria-label");n&&e.push(n);const o=t.closest("[class*='upload'], [class*='Upload'], div, fieldset, section, td, li")||t.parentElement;return o&&e.push((o.textContent||"").slice(0,300)),e.join(" ").trim()}function q(t){const e=document.createElement("button");return e.type="button",e.className=N,e.textContent="‚ö°",e.title="xUpload: Smart file recommendation",e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),z(t,e)}),e}async function S(t,e){const n=[];for await(const o of t.values()){const a=e?`${e}/${o.name}`:o.name;if(o.kind==="file")n.push({fileHandle:o,path:a});else if(o.kind==="directory"&&!o.name.startsWith(".")){const i=await S(o,a);n.push(...i)}}return n}function G(t){var o;const e=((o=t.split(".").pop())==null?void 0:o.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[e]||"application/octet-stream"}const F=["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"];async function X(t,e){var i;const n=t.name.replace(/[._-]/g," "),o=((i=t.name.split(".").pop())==null?void 0:i.toLowerCase())||"",a=e?e.replace(/[/\\._-]/g," "):n;if(F.includes(o))try{const c=await t.text();return`${a} ${c.slice(0,2e3)}`}catch{return a}if(o==="pdf")try{const c=await t.arrayBuffer(),m=new Uint8Array(c);let p="";const s=Math.min(m.length,5e5);for(let u=0;u<s;u++)p+=String.fromCharCode(m[u]);const r=[],f=/BT\s([\s\S]*?)ET/g;let h;for(;(h=f.exec(p))!==null;){const u=/\(([^)]*)\)/g;let v;for(;(v=u.exec(h[1]))!==null;)r.push(v[1])}const x=r.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim();return x.length>10?`${a} ${x.slice(0,2e3)}`:`${a} pdf document`}catch{return`${a} pdf document`}return["jpg","jpeg","png","gif","webp","bmp","svg","tiff","heic"].includes(o)?`${a} image photo picture`:["doc","docx"].includes(o)?`${a} document word`:["xls","xlsx"].includes(o)?`${a} spreadsheet excel`:["ppt","pptx"].includes(o)?`${a} presentation slides`:a}async function K(t,e=w("scan-inline")){d(e,"scan.inline.start");try{d(e,"service.filesystem.showDirectoryPicker.start"),b=await window.showDirectoryPicker({mode:"read"}),d(e,"service.filesystem.showDirectoryPicker.done")}catch(c){return c.name==="AbortError"||T(e,"scan.inline.showDirectoryPicker.failed",c),!1}if(!b)return!1;t&&(t.textContent="Scanning files...");const n=await S(b,"");d(e,"service.filesystem.collectFiles.done",{discoveredFiles:n.length}),t&&(t.textContent=`Found ${n.length} files. Reading...`);const o=[];let a=0;for(let c=0;c<n.length;c++){const{fileHandle:m,path:p}=n[c];try{const s=await m.getFile(),r=await X(s,p);o.push({path:p,name:s.name,type:s.type||G(s.name),size:s.size,lastModified:s.lastModified,text:r})}catch{a++}c%10===0&&t&&(t.textContent=`Reading files... ${c+1}/${n.length}`)}t&&(t.textContent="Building index..."),d(e,"scan.inline.read.done",{processedFiles:o.length,unreadable:a});const i=await chrome.runtime.sendMessage({type:"BUILD_INDEX",files:o,workflowId:e});return d(e,"service.background.BUILD_INDEX.done",i),t&&(t.textContent=`Done! ${(i==null?void 0:i.count)||o.length} files indexed.`),d(e,"scan.inline.done",{indexedFiles:(i==null?void 0:i.count)||o.length}),!0}async function z(t,e){var o;const n=w("recommend");document.querySelectorAll(`.${C}`).forEach(a=>a.remove()),d(n,"recommend.start",{contextPreview:t.context.slice(0,140),accept:t.accept||"(none)",url:window.location.href});try{d(n,"service.background.GET_INDEX_COUNT.start");const a=await chrome.runtime.sendMessage({type:"GET_INDEX_COUNT"});if(d(n,"service.background.GET_INDEX_COUNT.done",a),!(a!=null&&a.count)||a.count===0){I(e,t,n);return}await L(e,t,n)}catch(a){T(n,"recommend.failed",a);const i=(o=a==null?void 0:a.message)!=null&&o.includes("Extension context invalidated")?"Extension was updated. Please refresh this page.":"Error getting recommendations.";E(e,t,[],i,n)}}function I(t,e,n){const o=document.createElement("div");o.className=C;const a=document.createElement("div");a.className="xupload-header",a.textContent="‚ö° xUpload",o.appendChild(a);const i=document.createElement("div");i.className="xupload-empty",i.textContent="No files indexed yet.",o.appendChild(i);const c=document.createElement("button");c.type="button",c.className="xupload-scan-btn",c.textContent="Select folder to scan",c.style.cssText="display:block;width:100%;margin-top:8px;padding:8px 12px;background:#4285f4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;",c.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),c.disabled=!0,c.textContent="Scanning...";const r=w("scan-inline");d(n,"recommend.inline_scan.requested",{scanWorkflowId:r}),await K(i,r)?(o.remove(),await L(t,e,n)):(c.disabled=!1,c.textContent="Select folder to scan",i.textContent="Scan cancelled. Try again.")}),o.appendChild(c);const m=s=>{o.contains(s.target)||(o.remove(),document.removeEventListener("click",m))};setTimeout(()=>document.addEventListener("click",m),0);const p=t.getBoundingClientRect();o.style.position="fixed",o.style.top=`${p.bottom+4}px`,o.style.left=`${p.left}px`,document.body.appendChild(o)}async function Q(){return new Promise(t=>{chrome.storage.local.get("xupload_config",e=>{t(e.xupload_config||{apiKey:"",mode:"tfidf"})})})}async function L(t,e,n){var c,m,p,s;const o=await Q();if(d(n,"recommend.config.loaded",{mode:o.mode,hasApiKey:!!o.apiKey}),o.apiKey&&o.mode!=="tfidf"){let r;if(o.mode==="vlm")try{const x=t.getBoundingClientRect(),u=await chrome.runtime.sendMessage({type:"CAPTURE_TAB"});u!=null&&u.base64&&(r=await V(u.base64,{top:Math.max(0,x.top-150),left:Math.max(0,x.left-100),width:Math.min(800,window.innerWidth-x.left+200),height:Math.min(600,400)}))}catch(x){T(n,"service.background.CAPTURE_TAB.failed",x)}const f={type:"MATCH_REQUEST_ENHANCED",context:e.context,accept:e.accept,pageUrl:window.location.href,workflowId:n,mode:o.mode,screenshotBase64:r},h=await chrome.runtime.sendMessage(f);if(d(n,"service.background.MATCH_REQUEST_ENHANCED.done",{responseWorkflowId:h==null?void 0:h.workflowId,resultCount:((c=h==null?void 0:h.results)==null?void 0:c.length)||0}),!((m=h==null?void 0:h.results)!=null&&m.length)){E(t,e,[],"No matching files found.",n);return}E(t,e,h.results,void 0,n);return}const a={type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:window.location.href,workflowId:n},i=await chrome.runtime.sendMessage(a);if(d(n,"service.background.MATCH_REQUEST.done",{responseWorkflowId:i==null?void 0:i.workflowId,resultCount:((p=i==null?void 0:i.results)==null?void 0:p.length)||0}),!((s=i==null?void 0:i.results)!=null&&s.length)){E(t,e,[],"No matching files found.",n);return}d(n,"recommend.results.shown",{resultCount:i.results.length}),E(t,e,i.results,void 0,n)}async function V(t,e){const n=new Image;await new Promise((r,f)=>{n.onload=()=>r(),n.onerror=f,n.src=`data:image/png;base64,${t}`});const o=window.devicePixelRatio||1,a=e.left*o,i=e.top*o,c=e.width*o,m=e.height*o,p=document.createElement("canvas");return p.width=c,p.height=m,p.getContext("2d").drawImage(n,a,i,c,m,0,0,c,m),p.toDataURL("image/png").replace(/^data:image\/\w+;base64,/,"")}function E(t,e,n,o,a=w("panel")){const i=document.createElement("div");i.className=C;const c=document.createElement("div");if(c.className="xupload-header",c.textContent=n.length>0?`‚ö° ${n.length} files recommended`:"‚ö° xUpload",i.appendChild(c),n.length===0){const s=document.createElement("div");s.className="xupload-empty",s.textContent=o||"No results",i.appendChild(s)}else{const s=document.createElement("ul");for(const r of n){const f=document.createElement("li");f.className="xupload-item";const h=document.createElement("span");h.className="xupload-icon",h.textContent=A(r.type,r.name);const x=document.createElement("div");x.className="xupload-info";const u=document.createElement("span");u.className="xupload-name",u.textContent=r.name;const v=document.createElement("span");if(v.className="xupload-path",v.textContent=r.path,x.appendChild(u),x.appendChild(v),r.historyCount&&r.historyCount>0){const g=document.createElement("span");g.className="xupload-history-badge",g.textContent=`Used ${r.historyCount}x here`,x.appendChild(g)}const y=document.createElement("span");y.className="xupload-score";const l=Math.round(r.score*100);y.textContent=`${l}%`,f.appendChild(h),f.appendChild(x),f.appendChild(y),f.title=`Click to select: ${r.name}`,f.addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation(),y.textContent="...",f.classList.add("xupload-loading"),d(a,"recommend.file.click",{fileId:r.id,fileName:r.name,score:Math.round(r.score*100)});const P=await Z(r.id,a);if(f.classList.remove("xupload-loading"),y.textContent=`${l}%`,!P){y.textContent="Error",y.style.color="#ea4335",d(a,"recommend.file.read_failed",{fileId:r.id});return}i.remove(),ee(t,e,P,r,a)}),s.appendChild(f)}i.appendChild(s)}const m=s=>{i.contains(s.target)||(i.remove(),document.removeEventListener("click",m))};setTimeout(()=>document.addEventListener("click",m),0);const p=t.getBoundingClientRect();i.style.position="fixed",i.style.top=`${p.bottom+4}px`,i.style.left=`${p.left}px`,document.body.appendChild(i)}function A(t,e){var o;const n=((o=e.split(".").pop())==null?void 0:o.toLowerCase())||"";return n==="pdf"||t==="application/pdf"?"üìÑ":["doc","docx"].includes(n)?"üìÉ":["jpg","jpeg","png","gif","webp"].includes(n)?"üñºÔ∏è":["xls","xlsx","csv"].includes(n)?"üìä":"üìÅ"}const Y=["jpg","jpeg","png","gif","webp","bmp","svg"];function J(t){var e;return((e=t.split(".").pop())==null?void 0:e.toLowerCase())||""}async function Z(t,e){d(e,"service.content.readFileFromHandle.start",{fileId:t});let n=await ne(t);if(n)return d(e,"service.content.readFileFromHandle.done",{source:"in_memory_handle"}),n;try{d(e,"service.background.GET_FILE.start",{fileId:t});const o=await chrome.runtime.sendMessage({type:"GET_FILE",id:t});if(o&&!o.error&&o.base64){const a=atob(o.base64),i=new Uint8Array(a.length);for(let c=0;c<a.length;c++)i[c]=a.charCodeAt(c);return d(e,"service.background.GET_FILE.done",{source:"background_handle"}),new File([i],o.name,{type:o.type,lastModified:o.lastModified})}d(e,"service.background.GET_FILE.empty",(o==null?void 0:o.error)||"no_data")}catch(o){T(e,"service.background.GET_FILE.failed",o)}return d(e,"service.content.read_file.failed",{reason:"missing_or_expired_directory_permission",action:"rescan_from_popup_if_needed"}),null}function ee(t,e,n,o,a){document.querySelectorAll(`.${C}`).forEach(l=>l.remove());const i=document.createElement("div");i.className=C+" xupload-preview";const c=document.createElement("div");c.className="xupload-header",c.innerHTML="";const m=document.createElement("span");m.textContent=A(o.type,o.name),m.style.marginRight="6px";const p=document.createElement("span");p.textContent=o.name,c.appendChild(m),c.appendChild(p),i.appendChild(c);const s=document.createElement("div");s.className="xupload-preview-content",i.appendChild(s);const r=J(n.name),f=URL.createObjectURL(n);if(Y.includes(r)){const l=document.createElement("img");l.src=f,l.className="xupload-preview-img",l.alt=n.name,s.appendChild(l)}else if(r==="pdf"){const l=document.createElement("embed");l.src=f,l.type="application/pdf",l.className="xupload-preview-pdf",s.appendChild(l)}else if(F.includes(r)){const l=document.createElement("pre");l.className="xupload-preview-text",n.text().then(g=>{l.textContent=g.slice(0,5e3),g.length>5e3&&(l.textContent+=`

... (truncated)`)}),s.appendChild(l)}else{const l=document.createElement("div");l.className="xupload-preview-info",l.textContent=`${n.name} (${(n.size/1024).toFixed(1)} KB)`,s.appendChild(l)}const h=document.createElement("div");h.className="xupload-preview-actions";const x=document.createElement("button");x.type="button",x.className="xupload-preview-btn xupload-preview-back",x.textContent="Back",x.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),URL.revokeObjectURL(f),i.remove(),L(t,e,a)});const u=document.createElement("button");u.type="button",u.className="xupload-preview-btn xupload-preview-use",u.textContent="Use this file",u.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation(),u.disabled=!0,u.textContent="Filling...",d(a,"recommend.fill.start",{fileId:o.id,fileName:o.name,path:o.path});const g=te(e,n);if(URL.revokeObjectURL(f),g){d(a,"recommend.fill.done",{method:"setFileInput_or_drop"}),u.textContent="‚úì Done",u.classList.add("xupload-preview-done"),setTimeout(()=>i.remove(),600);try{chrome.runtime.sendMessage({type:"TRACK_UPLOAD",entry:{fileId:o.id,fileName:o.name,fileType:o.type,websiteHost:new URL(window.location.href).hostname,pageUrl:window.location.href,pageTitle:document.title,uploadContext:e.context.slice(0,200),timestamp:Date.now()}},()=>{chrome.runtime.lastError}),chrome.runtime.sendMessage({type:"SAVE_USED_PATH",host:new URL(window.location.href).hostname,filePath:o.path},()=>{chrome.runtime.lastError}),d(a,"recommend.memory.saved",{host:new URL(window.location.href).hostname,filePath:o.path})}catch{}}else d(a,"recommend.fill.failed"),u.textContent="Error",u.disabled=!1}),h.appendChild(x),h.appendChild(u),i.appendChild(h);const v=l=>{i.contains(l.target)||(URL.revokeObjectURL(f),i.remove(),document.removeEventListener("click",v))};setTimeout(()=>document.addEventListener("click",v),0);const y=t.getBoundingClientRect();i.style.position="fixed",i.style.top=`${Math.min(y.bottom+4,window.innerHeight-500)}px`,i.style.left=`${y.left}px`,document.body.appendChild(i)}function te(t,e){try{if(t.fileInput)return D(t.fileInput,e),!0;const n=$(t.anchor);if(n)return D(n,e),!0;const o=t.anchor.closest("[class*='upload'], [class*='Upload'], [class*='drop']")||t.anchor,a=new DataTransfer;return a.items.add(e),o.dispatchEvent(new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:a})),!0}catch(n){return console.error("[xUpload] Fill error:",n),!1}}async function ne(t){if(!b)return null;try{const e=t.split("/");let n=b;for(let a=0;a<e.length-1;a++)n=await n.getDirectoryHandle(e[a]);return await(await n.getFileHandle(e[e.length-1])).getFile()}catch(e){return console.error("[xUpload] Failed to read file from handle:",e),null}}function D(t,e){const n=new DataTransfer;n.items.add(e),t.files=n.files,t.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new Event("input",{bubbles:!0}))}const U=new Map;function M(t,e){const n=e.getBoundingClientRect();n.width===0&&n.height===0||(t.style.position="fixed",t.style.top=`${n.top+(n.height-28)/2}px`,t.style.left=`${n.right+4}px`)}function R(){for(const[t,e]of U){if(!document.body.contains(e.anchor)){t.remove(),U.delete(t);continue}M(t,e.anchor)}}function H(){const t=B();for(const e of t){if(_.has(e.anchor))continue;_.add(e.anchor);const n=q(e);n.style.zIndex="2147483646",document.body.appendChild(n),M(n,e.anchor),U.set(n,e)}}H(),new MutationObserver(()=>H()).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("scroll",R,{passive:!0}),window.addEventListener("resize",R,{passive:!0})})();
