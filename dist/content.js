(function(){"use strict";function D(e){const n=Date.now().toString(36),t=Math.random().toString(36).slice(2,8);return`${e}-${n}-${t}`}function m(e,n,t){if(t===void 0){console.log(`[xUpload][WF:${e}] ${n}`);return}console.log(`[xUpload][WF:${e}] ${n}`,t)}function _(e,n,t){console.error(`[xUpload][WF:${e}] ${n}`,t)}const z="xupload-zone",S="xupload-panel",T="xupload-badge",$=new WeakSet,E=new WeakMap,A=new Set;let y=null,w=null,L=null,x=null,b=null,v=!0;function K(){const e=[],n=new Set;return document.querySelectorAll('input[type="file"]').forEach(t=>{if($.has(t))return;const o=X(t);!o||n.has(o)||$.has(o)||(n.add(o),e.push({zone:o,fileInput:t,context:B(t,o),accept:t.accept||void 0}))}),e}function X(e){const n=e.closest(['[class*="upload"]','[class*="Upload"]','[class*="drop"]','[class*="Drop"]','[class*="attach"]','[class*="Attach"]','[class*="file-input"]','[class*="file-picker"]'].join(","));if(n&&M(n))return n;const t=e.closest('label, fieldset, [class*="form-group"], [class*="field"], [class*="input-group"]');if(t&&M(t))return t;let o=e.parentElement;for(let a=0;a<5&&o&&o!==document.body;a++){if(M(o))return o;o=o.parentElement}return e.parentElement}function M(e){const n=e.getBoundingClientRect();return n.width>40&&n.height>30&&n.width<window.innerWidth*.9}function B(e,n){const t=[];if(e.id){const l=document.querySelector(`label[for="${e.id}"]`);l&&t.push(l.textContent||"")}const o=e.closest("label");o&&t.push(o.textContent||""),e.placeholder&&t.push(e.placeholder),e.title&&t.push(e.title);const a=e.getAttribute("aria-label");a&&t.push(a),t.push((n.textContent||"").slice(0,500));const c=n.closest('[role="dialog"]')||n.closest('[role="main"]')||n.closest("form")||document.body,i=c.querySelector('input[name*="subject" i], input[placeholder*="subject" i], input[aria-label*="subject" i]');i!=null&&i.value&&t.push(i.value);const s=c.querySelectorAll('[contenteditable="true"]');for(const l of s){const r=(l.textContent||"").trim();r.length>5&&t.push(r.slice(0,300))}return t.join(" ").trim()}function Q(e){if($.add(e.zone),$.add(e.fileInput),A.add(e.zone),e.zone.classList.add(z),getComputedStyle(e.zone).position==="static"&&(e.zone.style.position="relative"),!e.zone.querySelector(`.${T}`)){const o=document.createElement("span");o.className=T,o.textContent="âš¡ xUpload",e.zone.appendChild(o)}const n=()=>{v&&V(e)},t=()=>{v&&Y()};e.zone.addEventListener("mouseenter",n),e.zone.addEventListener("mouseleave",t)}function H(){b&&(clearTimeout(b),b=null)}function j(e=300){H(),b=setTimeout(()=>{N()},e)}function N(){w&&(w.remove(),w=null,L=null)}function V(e){H(),!(w&&(L==null?void 0:L.zone)===e.zone)&&(x&&(clearTimeout(x),x=null),x=setTimeout(()=>{x=null,N(),I(e)},250))}function Y(){x&&(clearTimeout(x),x=null),j()}async function I(e){var s;const n=B(e.fileInput,e.zone);n!==e.context&&(e.context=n,E.delete(e.zone));const t=D("recommend");m(t,"recommend.start",{contextPreview:e.context.slice(0,140),accept:e.accept||"(none)",url:window.location.href});const o=document.createElement("div");o.className=S,o.addEventListener("mouseenter",H),o.addEventListener("mouseleave",()=>j());const a=document.createElement("div");a.className="xupload-header",a.textContent="âš¡ Recommended files",o.appendChild(a);const c=document.createElement("div");c.className="xupload-loading-msg",c.textContent="Finding best filesâ€¦",o.appendChild(c);const i=k(e);o.appendChild(i),R(o,e.zone),document.body.appendChild(o),w=o,L=e;try{const l=await chrome.runtime.sendMessage({type:"GET_INDEX_COUNT"});if(!(l!=null&&l.count)||l.count===0){c.remove(),J(o,i,e,t);return}const r=E.get(e.zone);if(r){c.remove(),U(o,i,r,e,t);return}const u=await W(e,t);E.set(e.zone,u),c.remove(),U(o,i,u,e,t)}catch(l){c.remove(),_(t,"recommend.failed",l);const r=document.createElement("div");r.className="xupload-empty",r.textContent=(s=l==null?void 0:l.message)!=null&&s.includes("Extension context invalidated")?"Extension was updated. Please refresh this page.":"Error getting recommendations.",o.insertBefore(r,i)}}function k(e){const n=document.createElement("div");n.className="xupload-panel-footer";const t=document.createElement("button");return t.type="button",t.className="xupload-default-btn",t.textContent="ðŸ“‚ Use default upload",t.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),N(),e.fileInput.click()}),n.appendChild(t),n}function U(e,n,t,o,a){if(!t.length){const s=document.createElement("div");s.className="xupload-empty",s.textContent="No matching files found.",e.insertBefore(s,n);return}const c=e.querySelector(".xupload-header");c&&(c.textContent=`âš¡ ${t.length} file${t.length>1?"s":""} recommended`);const i=document.createElement("ul");for(const s of t){const l=document.createElement("li");l.className="xupload-item";const r=document.createElement("span");r.className="xupload-icon",r.textContent=O(s.type,s.name);const u=document.createElement("div");u.className="xupload-info";const f=document.createElement("span");f.className="xupload-name",f.textContent=s.name;const h=document.createElement("span");if(h.className="xupload-path",h.textContent=s.path,u.appendChild(f),u.appendChild(h),s.historyCount&&s.historyCount>0){const d=document.createElement("span");d.className="xupload-history-badge",d.textContent=`Used ${s.historyCount}x here`,u.appendChild(d)}const p=document.createElement("span");p.className="xupload-score";const g=Math.round(s.score*100);p.textContent=`${g}%`,l.appendChild(r),l.appendChild(u),l.appendChild(p),l.title=`Click to select: ${s.name}`,l.addEventListener("click",async d=>{d.preventDefault(),d.stopPropagation(),p.textContent="...",l.classList.add("xupload-item-loading"),m(a,"recommend.file.click",{fileId:s.id,fileName:s.name,score:Math.round(s.score*100)});const C=await ie(s.id,a);if(l.classList.remove("xupload-item-loading"),p.textContent=`${g}%`,!C){p.textContent="Error",p.style.color="#ea4335",m(a,"recommend.file.read_failed",{fileId:s.id});const F=document.createElement("div");F.className="xupload-permission-error",F.textContent="âš ï¸ Permission expired. Please click the âš¡ xUpload icon and click 'Rescan folder' to re-authorize.",F.style.cssText="padding: 8px; margin: 8px 0; background: #fef7e0; border-radius: 4px; font-size: 12px; color: #856404;",e.insertBefore(F,n);return}N(),ae(o,C,s,a)}),i.appendChild(l)}e.insertBefore(i,n)}function J(e,n,t,o){const a=document.createElement("div");a.className="xupload-empty",a.textContent="No files indexed yet.",e.insertBefore(a,n);const c=document.createElement("button");c.type="button",c.className="xupload-scan-btn",c.textContent="Select folder to scan",c.addEventListener("click",async i=>{i.preventDefault(),i.stopPropagation(),c.disabled=!0,c.textContent="Scanningâ€¦";const s=D("scan-inline");if(m(o,"recommend.inline_scan.requested",{scanWorkflowId:s}),await ue(a,s)){a.remove(),c.remove();const r=document.createElement("div");r.className="xupload-loading-msg",r.textContent="Finding best filesâ€¦",e.insertBefore(r,n);try{const u=await W(t,o);E.set(t.zone,u),r.remove(),U(e,n,u,t,o)}catch{r.remove()}}else c.disabled=!1,c.textContent="Select folder to scan",a.textContent="Scan cancelled. Try again."}),e.insertBefore(c,n)}function R(e,n){const t=n.getBoundingClientRect();e.style.position="fixed",e.style.zIndex="2147483647";const o=Math.max(4,Math.min(t.left,window.innerWidth-380));e.style.left=`${o}px`,e.style.top="-9999px",e.style.maxHeight=`${window.innerHeight-16}px`,e.style.overflowY="auto",requestAnimationFrame(()=>{const a=e.getBoundingClientRect().height,c=window.innerHeight-t.bottom-8,i=t.top-8;let s;c>=a?s=t.bottom+6:i>=a?s=t.top-a-6:c>=i?s=window.innerHeight-a-8:s=8,e.style.top=`${Math.max(8,s)}px`})}async function ee(){return new Promise(e=>{chrome.storage.local.get("xupload_config",n=>{e(n.xupload_config||{apiKey:"",mode:"tfidf"})})})}async function W(e,n){var c,i;const t=await ee();if(m(n,"recommend.config.loaded",{mode:t.mode,hasApiKey:!!t.apiKey}),t.apiKey&&t.mode!=="tfidf"){let s;if(t.mode==="vlm")try{const u=e.zone.getBoundingClientRect(),f=await chrome.runtime.sendMessage({type:"CAPTURE_TAB"});f!=null&&f.base64&&(s=await te(f.base64,{top:Math.max(0,u.top-150),left:Math.max(0,u.left-100),width:Math.min(800,window.innerWidth-u.left+200),height:Math.min(600,400)}))}catch(u){_(n,"service.background.CAPTURE_TAB.failed",u)}const l={type:"MATCH_REQUEST_ENHANCED",context:e.context,accept:e.accept,pageUrl:window.location.href,workflowId:n,mode:t.mode,screenshotBase64:s},r=await chrome.runtime.sendMessage(l);return m(n,"service.background.MATCH_REQUEST_ENHANCED.done",{responseWorkflowId:r==null?void 0:r.workflowId,resultCount:((c=r==null?void 0:r.results)==null?void 0:c.length)||0}),(r==null?void 0:r.results)||[]}const o={type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:window.location.href,workflowId:n},a=await chrome.runtime.sendMessage(o);return m(n,"service.background.MATCH_REQUEST.done",{responseWorkflowId:a==null?void 0:a.workflowId,resultCount:((i=a==null?void 0:a.results)==null?void 0:i.length)||0}),(a==null?void 0:a.results)||[]}async function te(e,n){const t=new Image;await new Promise((u,f)=>{t.onload=()=>u(),t.onerror=f,t.src=`data:image/png;base64,${e}`});const o=window.devicePixelRatio||1,a=n.left*o,c=n.top*o,i=n.width*o,s=n.height*o,l=document.createElement("canvas");return l.width=i,l.height=s,l.getContext("2d").drawImage(t,a,c,i,s,0,0,i,s),l.toDataURL("image/png").replace(/^data:image\/\w+;base64,/,"")}const ne=["jpg","jpeg","png","gif","webp","bmp","svg"],q=["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"];function O(e,n){var o;const t=((o=n.split(".").pop())==null?void 0:o.toLowerCase())||"";return t==="pdf"||e==="application/pdf"?"ðŸ“„":["doc","docx"].includes(t)?"ðŸ“ƒ":["jpg","jpeg","png","gif","webp"].includes(t)?"ðŸ–¼ï¸":["xls","xlsx","csv"].includes(t)?"ðŸ“Š":"ðŸ“"}function oe(e){var n;return((n=e.split(".").pop())==null?void 0:n.toLowerCase())||""}function ae(e,n,t,o){document.querySelectorAll(`.${S}`).forEach(d=>d.remove()),w=null,L=null;const a=document.createElement("div");a.className=S+" xupload-preview";const c=document.createElement("div");c.className="xupload-header";const i=document.createElement("span");i.textContent=O(t.type,t.name),i.style.marginRight="6px";const s=document.createElement("span");s.textContent=t.name,c.appendChild(i),c.appendChild(s),a.appendChild(c);const l=document.createElement("div");l.className="xupload-preview-content",a.appendChild(l);const r=oe(n.name),u=URL.createObjectURL(n);if(ne.includes(r)){const d=document.createElement("img");d.src=u,d.className="xupload-preview-img",d.alt=n.name,l.appendChild(d)}else if(r==="pdf"){const d=document.createElement("embed");d.src=u,d.type="application/pdf",d.className="xupload-preview-pdf",l.appendChild(d)}else if(q.includes(r)){const d=document.createElement("pre");d.className="xupload-preview-text",n.text().then(C=>{d.textContent=C.slice(0,5e3),C.length>5e3&&(d.textContent+=`

... (truncated)`)}),l.appendChild(d)}else{const d=document.createElement("div");d.className="xupload-preview-info",d.textContent=`${n.name} (${(n.size/1024).toFixed(1)} KB)`,l.appendChild(d)}const f=document.createElement("div");f.className="xupload-preview-actions";const h=document.createElement("button");h.type="button",h.className="xupload-preview-btn xupload-preview-back",h.textContent="Back",h.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),URL.revokeObjectURL(u),a.remove(),ce(e,o)});const p=document.createElement("button");p.type="button",p.className="xupload-preview-btn xupload-preview-use",p.textContent="Use this file",p.addEventListener("click",async d=>{d.preventDefault(),d.stopPropagation(),p.disabled=!0,p.textContent="Fillingâ€¦",m(o,"recommend.fill.start",{fileId:t.id,fileName:t.name,path:t.path});const C=se(e,n);if(URL.revokeObjectURL(u),C){m(o,"recommend.fill.done",{method:"setFileInput_or_drop"}),p.textContent="âœ“ Done",p.classList.add("xupload-preview-done"),setTimeout(()=>a.remove(),600);try{chrome.runtime.sendMessage({type:"TRACK_UPLOAD",entry:{fileId:t.id,fileName:t.name,fileType:t.type,websiteHost:new URL(window.location.href).hostname,pageUrl:window.location.href,pageTitle:document.title,uploadContext:e.context.slice(0,200),timestamp:Date.now()}},()=>void chrome.runtime.lastError),chrome.runtime.sendMessage({type:"SAVE_USED_PATH",host:new URL(window.location.href).hostname,filePath:t.path},()=>void chrome.runtime.lastError),m(o,"recommend.memory.saved",{host:new URL(window.location.href).hostname,filePath:t.path})}catch{}E.delete(e.zone)}else m(o,"recommend.fill.failed"),p.textContent="Error",p.disabled=!1}),f.appendChild(h),f.appendChild(p),a.appendChild(f);const g=d=>{a.contains(d.target)||(URL.revokeObjectURL(u),a.remove(),document.removeEventListener("click",g))};setTimeout(()=>document.addEventListener("click",g),0),R(a,e.zone),document.body.appendChild(a)}function ce(e,n){const t=E.get(e.zone);if(!t)return;const o=document.createElement("div");o.className=S;const a=document.createElement("div");a.className="xupload-header",a.textContent=`âš¡ ${t.length} file${t.length>1?"s":""} recommended`,o.appendChild(a);const c=k(e);o.appendChild(c),U(o,c,t,e,n),R(o,e.zone),document.body.appendChild(o);const i=s=>{o.contains(s.target)||(o.remove(),document.removeEventListener("click",i))};setTimeout(()=>document.addEventListener("click",i),0)}async function ie(e,n){m(n,"service.content.readFileFromHandle.start",{fileId:e});let t=await Z(e);if(t)return m(n,"service.content.readFileFromHandle.done",{source:"in_memory_handle"}),t;try{m(n,"service.background.GET_FILE.start",{fileId:e});const o=await chrome.runtime.sendMessage({type:"GET_FILE",id:e});if(o&&!o.error&&o.base64){const a=atob(o.base64),c=new Uint8Array(a.length);for(let i=0;i<a.length;i++)c[i]=a.charCodeAt(i);return m(n,"service.background.GET_FILE.done",{source:"background_handle"}),new File([c],o.name,{type:o.type,lastModified:o.lastModified})}m(n,"service.background.GET_FILE.empty",(o==null?void 0:o.error)||"no_data")}catch(o){_(n,"service.background.GET_FILE.failed",o)}m(n,"service.content.reauthorize.start");try{if(y=await window.showDirectoryPicker({mode:"read"}),y){const o=await Z(e);if(o)return m(n,"service.content.reauthorize.done",{source:"reauthorized_handle"}),o}}catch(o){o.name!=="AbortError"&&_(n,"service.content.reauthorize.failed",o)}return m(n,"service.content.read_file.failed",{reason:"missing_or_expired_directory_permission",action:"user_cancelled_or_wrong_folder"}),null}async function Z(e){if(!y)return null;try{const n=e.split("/");let t=y;for(let a=0;a<n.length-1;a++)t=await t.getDirectoryHandle(n[a]);return await(await t.getFileHandle(n[n.length-1])).getFile()}catch(n){return console.error("[xUpload] Failed to read file from handle:",n),null}}function se(e,n){try{const t=e.zone.querySelector('input[type="file"]')||e.fileInput;return e.fileInput=t,le(t,n),!0}catch{try{const t=new DataTransfer;return t.items.add(n),e.zone.dispatchEvent(new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:t})),!0}catch(t){return console.error("[xUpload] Fill error:",t),!1}}}function le(e,n){var a;try{e.value=""}catch{}const t=new DataTransfer;t.items.add(n);const o=(a=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"files"))==null?void 0:a.set;o?o.call(e,t.files):e.files=t.files,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}async function G(e,n){const t=[];for await(const o of e.values()){const a=n?`${n}/${o.name}`:o.name;if(o.kind==="file")t.push({fileHandle:o,path:a});else if(o.kind==="directory"&&!o.name.startsWith(".")){const c=await G(o,a);t.push(...c)}}return t}function re(e){var o;const n=((o=e.split(".").pop())==null?void 0:o.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[n]||"application/octet-stream"}async function de(e,n){var c;const t=e.name.replace(/[._-]/g," "),o=((c=e.name.split(".").pop())==null?void 0:c.toLowerCase())||"",a=n?n.replace(/[/\\._-]/g," "):t;if(q.includes(o))try{const i=await e.text();return`${a} ${i.slice(0,2e3)}`}catch{return a}if(o==="pdf")try{const i=await e.arrayBuffer(),s=new Uint8Array(i);let l="";const r=Math.min(s.length,5e5);for(let g=0;g<r;g++)l+=String.fromCharCode(s[g]);const u=[],f=/BT\s([\s\S]*?)ET/g;let h;for(;(h=f.exec(l))!==null;){const g=/\(([^)]*)\)/g;let d;for(;(d=g.exec(h[1]))!==null;)u.push(d[1])}const p=u.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim();return p.length>10?`${a} ${p.slice(0,2e3)}`:`${a} pdf document`}catch{return`${a} pdf document`}return["jpg","jpeg","png","gif","webp","bmp","svg","tiff","heic"].includes(o)?`${a} image photo picture`:["doc","docx"].includes(o)?`${a} document word`:["xls","xlsx"].includes(o)?`${a} spreadsheet excel`:["ppt","pptx"].includes(o)?`${a} presentation slides`:a}async function ue(e,n=D("scan-inline")){m(n,"scan.inline.start");try{m(n,"service.filesystem.showDirectoryPicker.start"),y=await window.showDirectoryPicker({mode:"read"}),m(n,"service.filesystem.showDirectoryPicker.done")}catch(i){return i.name==="AbortError"||_(n,"scan.inline.showDirectoryPicker.failed",i),!1}if(!y)return!1;e&&(e.textContent="Scanning filesâ€¦");const t=await G(y,"");m(n,"service.filesystem.collectFiles.done",{discoveredFiles:t.length}),e&&(e.textContent=`Found ${t.length} files. Readingâ€¦`);const o=[];let a=0;for(let i=0;i<t.length;i++){const{fileHandle:s,path:l}=t[i];try{const r=await s.getFile(),u=await de(r,l);o.push({path:l,name:r.name,type:r.type||re(r.name),size:r.size,lastModified:r.lastModified,text:u})}catch{a++}i%10===0&&e&&(e.textContent=`Reading filesâ€¦ ${i+1}/${t.length}`)}e&&(e.textContent="Building indexâ€¦"),m(n,"scan.inline.read.done",{processedFiles:o.length,unreadable:a});const c=await chrome.runtime.sendMessage({type:"BUILD_INDEX",files:o,workflowId:n});return m(n,"service.background.BUILD_INDEX.done",c),e&&(e.textContent=`Done! ${(c==null?void 0:c.count)||o.length} files indexed.`),m(n,"scan.inline.done",{indexedFiles:(c==null?void 0:c.count)||o.length}),!0}function me(){v=!1,N(),x&&(clearTimeout(x),x=null),b&&(clearTimeout(b),b=null);for(const e of A){e.classList.remove(z);const n=e.querySelector(`.${T}`);n&&n.remove()}}function pe(){v=!0;for(const e of A)if(e.classList.add(z),!e.querySelector(`.${T}`)){const n=document.createElement("span");n.className=T,n.textContent="âš¡ xUpload",e.appendChild(n)}P()}function P(){if(!v)return;const e=K();for(const n of e)Q(n)}chrome.storage.local.get("xupload_enabled",e=>{v=e.xupload_enabled!==!1,v&&P()}),new MutationObserver(()=>P()).observe(document.body,{childList:!0,subtree:!0}),chrome.storage.onChanged.addListener((e,n)=>{if(n!=="local"||!e.xupload_enabled)return;const t=e.xupload_enabled.newValue!==!1;t&&!v?pe():!t&&v&&me()})})();
