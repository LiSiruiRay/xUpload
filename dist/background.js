import{g as H,a as L,i as E,b as y,c as J,s as X,d as _,l as d,t as N,v as O,e as Y,r as g,f as Z,h as $,j as q,k as b,m as ee,n as te,o as oe,u as ae,p as ne,q as I,w as ce,x as re,y as se,z as C}from"./workflow.js";const ie="https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",de="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";async function F(e,t){const o=await fetch(`${ie}?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:e.slice(0,8e3)}]}})});if(!o.ok){const r=await o.text();throw new Error(`Gemini embedding error ${o.status}: ${r}`)}return(await o.json()).embedding.values}async function le(e,t,o=10,a){const r=[];for(let s=0;s<e.length;s+=o){const l=e.slice(s,s+o),h=await Promise.all(l.map(i=>F(i,t)));r.push(...h),a==null||a(Math.min(s+o,e.length),e.length),s+o<e.length&&await new Promise(i=>setTimeout(i,200))}return r}async function he(e,t,o){var l,h,i,c,u;const a=await fetch(`${de}?key=${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inlineData:{mimeType:"image/png",data:e}},{text:`You are analyzing a webpage screenshot showing a file upload area. The surrounding text context is: "${t.slice(0,500)}"

Describe in 2-3 sentences what type of file this upload field is asking the user to provide. Be specific about the document type (e.g., passport, resume, transcript, photo ID, tax form, etc.). Focus on keywords that would help match against file names and content.`}]}],generationConfig:{maxOutputTokens:200,temperature:.2}})});if(!a.ok){const m=await a.text();throw new Error(`Gemini VLM error ${a.status}: ${m}`)}return((u=(c=(i=(h=(l=(await a.json()).candidates)==null?void 0:l[0])==null?void 0:h.content)==null?void 0:i.parts)==null?void 0:c[0])==null?void 0:u.text)||""}async function A(){if(y()>0)return;const e=await L();if(e){E(e),console.log("[xUpload] Vocab loaded from IndexedDB:",y(),"terms");return}return new Promise(t=>{chrome.storage.local.get("vocab",o=>{o.vocab?(E(o.vocab),console.log("[xUpload] Vocab loaded from chrome.storage:",y(),"terms"),I(o.vocab).catch(()=>{})):console.warn("[xUpload] No vocab found."),t()})})}A();chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type==="MATCH_REQUEST")return w(e).then(o),!0;if(e.type==="GET_FILE")return fe(e.id).then(o),!0;if(e.type==="GET_INDEX_COUNT")return H().then(a=>o({count:a})),!0;if(e.type==="BUILD_INDEX")return ge(e.files,e.workflowId).then(o),!0;if(e.type==="VOCAB_UPDATED")return(async()=>{const a=await L();a?(E(a),console.log("[xUpload] Vocab reloaded from IndexedDB:",y(),"terms")):chrome.storage.local.get("vocab",r=>{r.vocab&&(E(r.vocab),console.log("[xUpload] Vocab reloaded from chrome.storage:",y(),"terms"))}),o({ok:!0})})(),!0;if(e.type==="TRACK_UPLOAD"){const a=e.entry;return J(a).then(()=>{o({ok:!0})}).catch(r=>{console.error("[xUpload] Failed to track upload:",r),o({ok:!1})}),!0}if(e.type==="MATCH_REQUEST_ENHANCED")return me(e).then(o),!0;if(e.type==="CAPTURE_TAB")return chrome.tabs.captureVisibleTab({format:"png"},a=>{if(chrome.runtime.lastError){o({error:chrome.runtime.lastError.message});return}const r=(a==null?void 0:a.replace(/^data:image\/\w+;base64,/,""))||"";o({base64:r})}),!0;if(e.type==="SAVE_USED_PATH")return X(e.host,e.filePath).then(()=>o({ok:!0})).catch(()=>o({ok:!1})),!0;if(e.type==="RESCAN_CONFIG_UPDATED")return T().then(()=>o({ok:!0})),!0});function pe(e,t){const o=new Set(C(e.replace(/[/\\._-]/g," "))),a=new Set(C(t));if(o.size===0||a.size===0)return 0;let r=0;for(const l of o)a.has(l)&&r++;const s=Math.min(o.size,a.size);return r/s}function ue(e,t){const o=new Set(C(e)),a=new Set(C(t));if(o.size===0||a.size===0)return 0;let r=0;for(const l of a)o.has(l)&&r++;const s=Math.min(o.size,a.size);return r/s}async function w(e){const t=e.workflowId||_("match-bg"),o=new Set;d(t,"match.start",{contextPreview:e.context.slice(0,140),accept:e.accept||"(none)",pageUrl:e.pageUrl||"(none)"});try{o.add("background.ensureVocab"),await A();const a=N(e.context),r=O(a);d(t,"service.tfidf.vectorize",{queryTokenCount:a.length,queryVectorSize:r.length}),o.add("vectordb.search");const s=r.length>0?await Y(r,15,e.accept):[],l=s.length>0?Math.max(...s.map(n=>n.score)):0,h=l>.05;d(t,"service.vectordb.search.done",{candidateCount:s.length,maxTfidf:g(l),tfidfUseful:h});let i=s;h||(o.add("vectordb.getAll"),i=(await Z()).map(p=>({record:p,score:0})),d(t,"ranking.fallback.path_content",{reason:"tfidf_low_signal",maxTfidf:g(l),fullCandidateCount:i.length}));let c="";if(e.pageUrl)try{c=new URL(e.pageUrl).hostname}catch{c=""}let u=[],m=[];c&&(o.add("vectordb.getHistoryByHost"),o.add("vectordb.getUsedPaths"),u=await $(c),m=await q(c),d(t,"service.history.lookup.done",{host:c,historyRows:u.length,memorizedPaths:m.length}));const G=new Set(m),U=new Map;for(const n of u){const p=U.get(n.fileId);p?(p.count++,p.lastTs=Math.max(p.lastTs,n.timestamp)):U.set(n.fileId,{count:1,lastTs:n.timestamp})}const W=24*60*60*1e3,K=Date.now(),v=i.map(n=>{const p=n.score;let x=0,V=0;const S=U.get(n.record.id);if(S){V=S.count;const Q=(K-S.lastTs)/W;x=Math.max(.1,1-Q/90)}const B=pe(n.record.path,e.context),P=ue(n.record.textPreview,e.context),D=G.has(n.record.path)?1:0,z=x>0,f=h?z?{tfidf:.42,history:.28,path:.14,content:.08,pathMemory:.08}:{tfidf:.56,history:0,path:.22,content:.14,pathMemory:.08}:z?{tfidf:0,history:.36,path:.3,content:.2,pathMemory:.14}:{tfidf:0,history:0,path:.44,content:.42,pathMemory:.14},j=p*f.tfidf+x*f.history+B*f.path+P*f.content+D*f.pathMemory;return{...n,score:j,historyCount:V,debug:{tfidfScore:p,historyBoost:x,pathNameScore:B,contentOverlap:P,pathMemoryBoost:D,weights:f}}});v.sort((n,p)=>p.score-n.score);const M=v.slice(0,5).filter(n=>n.score>0);return d(t,"ranking.breakdown.top_candidates",v.slice(0,10).map((n,p)=>({rank:p+1,file:n.record.name,path:n.record.path,finalScore:g(n.score),tfidfScore:g(n.debug.tfidfScore),historyBoost:g(n.debug.historyBoost),pathNameScore:g(n.debug.pathNameScore),contentOverlap:g(n.debug.contentOverlap),pathMemoryBoost:n.debug.pathMemoryBoost,historyCount:n.historyCount,weights:n.debug.weights}))),d(t,"match.services_called",Array.from(o)),d(t,"match.done",{candidateCount:v.length,returnedCount:M.length,results:M.map(n=>`${n.record.name} (${Math.round(n.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:M.map(n=>({id:n.record.id,name:n.record.name,path:n.record.path,type:n.record.type,score:n.score,historyCount:n.historyCount}))}}catch(a){throw b(t,"match.failed",a),a}}async function R(){return new Promise(e=>{chrome.storage.local.get("xupload_config",t=>{e(t.xupload_config||{apiKey:"",mode:"tfidf"})})})}async function me(e){const t=e.workflowId||_("match-enhanced-bg"),o=new Set(["chrome.storage.local.get:xupload_config"]);d(t,"match.enhanced.start",{mode:e.mode,hasScreenshot:!!e.screenshotBase64,contextPreview:e.context.slice(0,140),accept:e.accept||"(none)"});const a=await R();if(!a.apiKey)return d(t,"match.enhanced.fallback",{reason:"missing_api_key"}),w({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let r=e.context;if(e.mode==="vlm"&&e.screenshotBase64)try{o.add("gemini.describeWithVLM"),d(t,"service.gemini.describeWithVLM.start");const s=await he(e.screenshotBase64,e.context,a.apiKey);d(t,"service.gemini.describeWithVLM.done",{descriptionPreview:s.slice(0,160)}),r=`${s} ${e.context}`}catch(s){b(t,"service.gemini.describeWithVLM.failed",s)}try{o.add("gemini.getEmbedding"),d(t,"service.gemini.getEmbedding.start");const s=await F(r,a.apiKey);o.add("vectordb.denseSearch");const l=await ee(s,5,e.accept);if(d(t,"service.vectordb.denseSearch.done",{queryVectorSize:s.length,candidateCount:l.length}),l.length===0)return d(t,"match.enhanced.fallback",{reason:"dense_no_results"}),w({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let h=[];if(e.pageUrl)try{const c=new URL(e.pageUrl).hostname;o.add("vectordb.getHistoryByHost"),h=await $(c)}catch{}const i=new Map;for(const c of h)i.set(c.fileId,(i.get(c.fileId)||0)+1);return d(t,"match.enhanced.services_called",Array.from(o)),d(t,"match.enhanced.done",{returnedCount:l.length,top:l.map(c=>`${c.record.name} (${Math.round(c.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:l.map(c=>({id:c.record.id,name:c.record.name,path:c.record.path,type:c.record.type,score:c.score,historyCount:i.get(c.record.id)||0}))}}catch(s){return b(t,"match.enhanced.failed",s),w({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t})}}async function ge(e,t=_("scan-bg")){const o=new Set(["embeddings.tokenize","embeddings.buildVocabulary","vectordb.clearAll","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","vectordb.getCount"]);d(t,"scan.background.start",{fileCount:e.length,mode:"full"});try{const a=e.map(i=>N(i.text));te(a),d(t,"scan.phase.tfidf.done",{tokenizedFiles:a.length}),await oe(),d(t,"service.vectordb.clearAll.done");const r=await R();o.add("chrome.storage.local.get:xupload_config");let s=new Array(e.length).fill(void 0);if(r.apiKey&&r.mode!=="tfidf"){o.add("gemini.batchEmbed"),d(t,"service.gemini.batchEmbed.start",{fileCount:e.length,mode:r.mode});try{const i=e.map(u=>u.text.slice(0,2e3)),c=await le(i,r.apiKey,10,(u,m)=>{d(t,"service.gemini.batchEmbed.progress",{done:u,total:m})});s=c,d(t,"service.gemini.batchEmbed.done",{vectorCount:c.length})}catch(i){b(t,"service.gemini.batchEmbed.failed",i)}}for(let i=0;i<e.length;i++){const c=e[i],u=O(a[i]);await ae({id:c.path,name:c.name,path:c.path,type:c.type,size:c.size,lastModified:c.lastModified,vector:u,denseVector:s[i],textPreview:c.text.slice(0,500)})}d(t,"service.vectordb.upsert.done",{upserted:e.length});const l=ne();await I(l),await new Promise(i=>{chrome.storage.local.set({vocab:l},i)}),d(t,"service.vocab.persist.done",{termCount:l.terms.length});const h=await H();return d(t,"scan.background.services_called",Array.from(o)),d(t,"scan.background.done",{indexedCount:h}),{ok:!0,count:h,workflowId:t}}catch(a){return b(t,"scan.background.failed",a),{ok:!1,error:(a==null?void 0:a.message)||String(a),workflowId:t}}}async function fe(e){console.log("[xUpload] GET_FILE:",e);const t=await ce(e);return t?(console.log("[xUpload] Sending:",t.name),t):{error:"Cannot read file. Please re-scan the folder from the xUpload popup."}}const k="xupload-rescan";async function T(){await chrome.alarms.clear(k);const e=await re();e.autoRescanEnabled&&e.rescanIntervalMin>0?(chrome.alarms.create(k,{periodInMinutes:e.rescanIntervalMin}),console.log(`[xUpload] Rescan alarm set: every ${e.rescanIntervalMin} min`)):console.log("[xUpload] Auto-rescan disabled")}chrome.alarms.onAlarm.addListener(async e=>{if(e.name!==k)return;console.log("[xUpload] Auto-rescan alarm fired");const t=await se();if(!t){console.log("[xUpload] No directory handle, skipping auto-rescan");return}try{if(await t.queryPermission({mode:"read"})!=="granted"){console.log("[xUpload] Directory permission not granted, skipping auto-rescan"),chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#ea4335"});return}chrome.action.setBadgeText({text:""}),console.log("[xUpload] Auto-rescan: directory handle valid, notifying tabs")}catch(o){console.error("[xUpload] Auto-rescan error:",o)}});chrome.runtime.onStartup.addListener(()=>{console.log("[xUpload] Extension started"),A(),T()});chrome.runtime.onInstalled.addListener(()=>{console.log("[xUpload] Extension installed/updated"),T()});T();
