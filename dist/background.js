import{g as L,a as O,i as U,b as C,c as Z,s as q,d as A,l as i,t as $,v as F,e as ee,r as m,f as te,h as R,j as w,k as oe,m as ae,n as ne,u as re,o as ce,p as G,q as se,w as ie,x as le,y as de,z as M}from"./workflow.js";const he="https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",pe="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";async function W(e,t){const o=await fetch(`${he}?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:e.slice(0,8e3)}]}})});if(!o.ok){const c=await o.text();throw new Error(`Gemini embedding error ${o.status}: ${c}`)}return(await o.json()).embedding.values}async function ue(e,t,o=10,a){const c=[];for(let s=0;s<e.length;s+=o){const d=e.slice(s,s+o),p=await Promise.all(d.map(l=>W(l,t)));c.push(...p),a==null||a(Math.min(s+o,e.length),e.length),s+o<e.length&&await new Promise(l=>setTimeout(l,200))}return c}async function ge(e,t,o){var d,p,l,r,u;const a=await fetch(`${pe}?key=${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inlineData:{mimeType:"image/png",data:e}},{text:`You are analyzing a webpage screenshot showing a file upload area. The surrounding text context is: "${t.slice(0,500)}"

Describe in 2-3 sentences what type of file this upload field is asking the user to provide. Be specific about the document type (e.g., passport, resume, transcript, photo ID, tax form, etc.). Focus on keywords that would help match against file names and content.`}]}],generationConfig:{maxOutputTokens:200,temperature:.2}})});if(!a.ok){const g=await a.text();throw new Error(`Gemini VLM error ${a.status}: ${g}`)}return((u=(r=(l=(p=(d=(await a.json()).candidates)==null?void 0:d[0])==null?void 0:p.content)==null?void 0:l.parts)==null?void 0:r[0])==null?void 0:u.text)||""}async function P(){if(C()>0)return;const e=await O();if(e){U(e),console.log("[xUpload] Vocab loaded from IndexedDB:",C(),"terms");return}return new Promise(t=>{chrome.storage.local.get("vocab",o=>{o.vocab?(U(o.vocab),console.log("[xUpload] Vocab loaded from chrome.storage:",C(),"terms"),G(o.vocab).catch(()=>{})):console.warn("[xUpload] No vocab found."),t()})})}P();chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type==="MATCH_REQUEST")return k(e).then(o),!0;if(e.type==="GET_FILE")return ve(e.id).then(o),!0;if(e.type==="GET_INDEX_COUNT")return L().then(a=>o({count:a})),!0;if(e.type==="BUILD_INDEX")return be(e.files,e.workflowId).then(o),!0;if(e.type==="VOCAB_UPDATED")return(async()=>{const a=await O();a?(U(a),console.log("[xUpload] Vocab reloaded from IndexedDB:",C(),"terms")):chrome.storage.local.get("vocab",c=>{c.vocab&&(U(c.vocab),console.log("[xUpload] Vocab reloaded from chrome.storage:",C(),"terms"))}),o({ok:!0})})(),!0;if(e.type==="TRACK_UPLOAD"){const a=e.entry;return Z(a).then(()=>{o({ok:!0})}).catch(c=>{console.error("[xUpload] Failed to track upload:",c),o({ok:!1})}),!0}if(e.type==="MATCH_REQUEST_ENHANCED")return ye(e).then(o),!0;if(e.type==="CAPTURE_TAB")return chrome.tabs.captureVisibleTab({format:"png"},a=>{if(chrome.runtime.lastError){o({error:chrome.runtime.lastError.message});return}const c=(a==null?void 0:a.replace(/^data:image\/\w+;base64,/,""))||"";o({base64:c})}),!0;if(e.type==="SAVE_USED_PATH")return q(e.host,e.filePath).then(()=>o({ok:!0})).catch(()=>o({ok:!1})),!0;if(e.type==="RESCAN_CONFIG_UPDATED")return _().then(()=>o({ok:!0})),!0;if(e.type==="CLEAR_SCANNED_DATA")return xe(e).then(o),!0});function me(e,t){const o=new Set(M(e.replace(/[/\\._-]/g," "))),a=new Set(M(t));if(o.size===0||a.size===0)return 0;let c=0;for(const d of o)a.has(d)&&c++;const s=Math.min(o.size,a.size);return c/s}function fe(e,t){const o=new Set(M(e)),a=new Set(M(t));if(o.size===0||a.size===0)return 0;let c=0;for(const d of a)o.has(d)&&c++;const s=Math.min(o.size,a.size);return c/s}async function k(e){const t=e.workflowId||A("match-bg"),o=new Set;i(t,"match.start",{contextPreview:e.context.slice(0,140),accept:e.accept||"(none)",pageUrl:e.pageUrl||"(none)"});try{o.add("background.ensureVocab"),await P();const a=$(e.context),c=F(a);i(t,"service.tfidf.vectorize",{queryTokenCount:a.length,queryVectorSize:c.length}),o.add("vectordb.search");const s=c.length>0?await ee(c,15,e.accept):[],d=s.length>0?Math.max(...s.map(n=>n.score)):0,p=d>.05;i(t,"service.vectordb.search.done",{candidateCount:s.length,maxTfidf:m(d),tfidfUseful:p});let l=s;p||(o.add("vectordb.getAll"),l=(await te()).map(h=>({record:h,score:0})),i(t,"ranking.fallback.path_content",{reason:"tfidf_low_signal",maxTfidf:m(d),fullCandidateCount:l.length}));let r="";if(e.pageUrl)try{r=new URL(e.pageUrl).hostname}catch{r=""}let u=[];r&&(o.add("vectordb.getHistoryByHost"),u=await R(r),i(t,"service.history.lookup.done",{host:r,historyRows:u.length}));const g=[];if(e.pageUrl)try{g.push(...new URL(e.pageUrl).pathname.split("/").filter(Boolean))}catch{}const S=new Map;for(const n of u){let h=1;if(g.length>0&&n.pageUrl)try{const b=new URL(n.pageUrl).pathname.split("/").filter(Boolean);let v=0;for(let y=0;y<Math.min(g.length,b.length)&&g[y]===b[y];y++)v++;h=v>=2?1:v===1?.4:.1}catch{}const f=n.fileId.split("/"),E=f.length>1?f.slice(0,-1).join("/"):"";S.set(E,(S.get(E)||0)+h)}const N=[...S.values()].reduce((n,h)=>n+h,0),V=new Map;for(const n of u){const h=V.get(n.fileId);h?(h.count++,h.lastTs=Math.max(h.lastTs,n.timestamp)):V.set(n.fileId,{count:1,lastTs:n.timestamp})}const K=24*60*60*1e3,Q=Date.now(),T=l.map(n=>{const h=n.score;let f=0,E=0;const b=V.get(n.record.id);if(b){E=b.count;const Y=(Q-b.lastTs)/K;f=Math.max(.1,1-Y/90)}const v=me(n.record.path,e.context),y=fe(n.record.textPreview,e.context),z=n.record.path.split("/"),J=z.length>1?z.slice(0,-1).join("/"):"",H=N>0?(S.get(J)||0)/N:0,I=f>0,x=p?I?{tfidf:.42,history:.28,path:.14,content:.08,pathMemory:.08}:{tfidf:.56,history:0,path:.22,content:.14,pathMemory:.08}:I?{tfidf:0,history:.36,path:.3,content:.2,pathMemory:.14}:{tfidf:0,history:0,path:.44,content:.42,pathMemory:.14},X=h*x.tfidf+f*x.history+v*x.path+y*x.content+H*x.pathMemory;return{...n,score:X,historyCount:E,debug:{tfidfScore:h,historyBoost:f,pathNameScore:v,contentOverlap:y,folderBoost:H,weights:x}}});T.sort((n,h)=>h.score-n.score);const B=T.slice(0,5).filter(n=>n.score>0);return i(t,"ranking.breakdown.top_candidates",T.slice(0,10).map((n,h)=>({rank:h+1,file:n.record.name,path:n.record.path,finalScore:m(n.score),tfidfScore:m(n.debug.tfidfScore),historyBoost:m(n.debug.historyBoost),pathNameScore:m(n.debug.pathNameScore),contentOverlap:m(n.debug.contentOverlap),folderBoost:m(n.debug.folderBoost),historyCount:n.historyCount,weights:n.debug.weights}))),i(t,"match.services_called",Array.from(o)),i(t,"match.done",{candidateCount:T.length,returnedCount:B.length,results:B.map(n=>`${n.record.name} (${Math.round(n.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:B.map(n=>({id:n.record.id,name:n.record.name,path:n.record.path,type:n.record.type,score:n.score,historyCount:n.historyCount}))}}catch(a){throw w(t,"match.failed",a),a}}async function j(){return new Promise(e=>{chrome.storage.local.get("xupload_config",t=>{e(t.xupload_config||{apiKey:"",mode:"tfidf"})})})}async function ye(e){const t=e.workflowId||A("match-enhanced-bg"),o=new Set(["chrome.storage.local.get:xupload_config"]);i(t,"match.enhanced.start",{mode:e.mode,hasScreenshot:!!e.screenshotBase64,contextPreview:e.context.slice(0,140),accept:e.accept||"(none)"});const a=await j();if(!a.apiKey)return i(t,"match.enhanced.fallback",{reason:"missing_api_key"}),k({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let c=e.context;if(e.mode==="vlm"&&e.screenshotBase64)try{o.add("gemini.describeWithVLM"),i(t,"service.gemini.describeWithVLM.start");const s=await ge(e.screenshotBase64,e.context,a.apiKey);i(t,"service.gemini.describeWithVLM.done",{descriptionPreview:s.slice(0,160)}),c=`${s} ${e.context}`}catch(s){w(t,"service.gemini.describeWithVLM.failed",s)}try{o.add("gemini.getEmbedding"),i(t,"service.gemini.getEmbedding.start");const s=await W(c,a.apiKey);o.add("vectordb.denseSearch");const d=await oe(s,5,e.accept);if(i(t,"service.vectordb.denseSearch.done",{queryVectorSize:s.length,candidateCount:d.length}),d.length===0)return i(t,"match.enhanced.fallback",{reason:"dense_no_results"}),k({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let p=[];if(e.pageUrl)try{const r=new URL(e.pageUrl).hostname;o.add("vectordb.getHistoryByHost"),p=await R(r)}catch{}const l=new Map;for(const r of p)l.set(r.fileId,(l.get(r.fileId)||0)+1);return i(t,"match.enhanced.services_called",Array.from(o)),i(t,"match.enhanced.done",{returnedCount:d.length,top:d.map(r=>`${r.record.name} (${Math.round(r.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:d.map(r=>({id:r.record.id,name:r.record.name,path:r.record.path,type:r.record.type,score:r.score,historyCount:l.get(r.record.id)||0}))}}catch(s){return w(t,"match.enhanced.failed",s),k({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t})}}async function be(e,t=A("scan-bg")){const o=new Set(["embeddings.tokenize","embeddings.buildVocabulary","vectordb.clearAll","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","vectordb.getCount"]);i(t,"scan.background.start",{fileCount:e.length,mode:"full"});try{const a=e.map(l=>$(l.text));ae(a),i(t,"scan.phase.tfidf.done",{tokenizedFiles:a.length}),await ne(),i(t,"service.vectordb.clearAll.done");const c=await j();o.add("chrome.storage.local.get:xupload_config");let s=new Array(e.length).fill(void 0);if(c.apiKey&&c.mode!=="tfidf"){o.add("gemini.batchEmbed"),i(t,"service.gemini.batchEmbed.start",{fileCount:e.length,mode:c.mode});try{const l=e.map(u=>u.text.slice(0,2e3)),r=await ue(l,c.apiKey,10,(u,g)=>{i(t,"service.gemini.batchEmbed.progress",{done:u,total:g})});s=r,i(t,"service.gemini.batchEmbed.done",{vectorCount:r.length})}catch(l){w(t,"service.gemini.batchEmbed.failed",l)}}for(let l=0;l<e.length;l++){const r=e[l],u=F(a[l]);await re({id:r.path,name:r.name,path:r.path,type:r.type,size:r.size,lastModified:r.lastModified,vector:u,denseVector:s[l],textPreview:r.text.slice(0,500)})}i(t,"service.vectordb.upsert.done",{upserted:e.length});const d=ce();await G(d),await new Promise(l=>{chrome.storage.local.set({vocab:d},l)}),i(t,"service.vocab.persist.done",{termCount:d.terms.length});const p=await L();return i(t,"scan.background.services_called",Array.from(o)),i(t,"scan.background.done",{indexedCount:p}),{ok:!0,count:p,workflowId:t}}catch(a){return w(t,"scan.background.failed",a),{ok:!1,error:(a==null?void 0:a.message)||String(a),workflowId:t}}}async function ve(e){console.log("[xUpload] GET_FILE:",e);const t=await se(e);return t?(console.log("[xUpload] Sending:",t.name),t):{error:"Permission expired. Click the xUpload extension icon and use 'Rescan folder' to re-authorize file access."}}async function xe(e){const t=e.workflowId||A("clear-bg");i(t,"clear.start");try{await ie(),await new Promise(a=>{chrome.storage.local.remove(["vocab"],()=>a())}),U({terms:[],idf:[]});const o=await L();return i(t,"clear.done",{remainingIndexedCount:o}),{ok:!0,count:o,workflowId:t}}catch(o){return w(t,"clear.failed",o),{ok:!1,error:(o==null?void 0:o.message)||String(o),workflowId:t}}}const D="xupload-rescan";async function _(){await chrome.alarms.clear(D);const e=await le();e.autoRescanEnabled&&e.rescanIntervalMin>0?(chrome.alarms.create(D,{periodInMinutes:e.rescanIntervalMin}),console.log(`[xUpload] Rescan alarm set: every ${e.rescanIntervalMin} min`)):console.log("[xUpload] Auto-rescan disabled")}chrome.alarms.onAlarm.addListener(async e=>{if(e.name!==D)return;console.log("[xUpload] Auto-rescan alarm fired");const t=await de();if(!t){console.log("[xUpload] No directory handle, skipping auto-rescan");return}try{if(await t.queryPermission({mode:"read"})!=="granted"){console.log("[xUpload] Directory permission not granted, skipping auto-rescan"),chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#ea4335"});return}chrome.action.setBadgeText({text:""}),console.log("[xUpload] Auto-rescan: directory handle valid, notifying tabs")}catch(o){console.error("[xUpload] Auto-rescan error:",o)}});chrome.runtime.onStartup.addListener(()=>{console.log("[xUpload] Extension started"),P(),_()});chrome.runtime.onInstalled.addListener(()=>{console.log("[xUpload] Extension installed/updated"),_()});_();
